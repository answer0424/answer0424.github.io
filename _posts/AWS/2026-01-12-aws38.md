---
layout: post
title: Amazon S3 지원 AMI를 EBS 지원 AMI로 변환
date: 2026-01-12 09:00:00 +09:00
categories: [AWS, EC2, AMI]
tags: [aws]
image:
    path: /assets/img/aws/AWS.png
---

## 개요

- EBS 기반 AMI는 인스턴스를 중지/시작해도 데이터가 유지되며 더 쉽고 빠르게 인스턴스를 시작할 수 있음
- 반면 S3-backed AMI는 이전 세대 워크플로우에서 사용되며 관리가 복잡할 수 있음

<hr>

## 전체 변환 절차

#### 1. EBS 기반 EC2 인스턴스 준비

- Amazon EBS-backed AMI에서 EC2 인스턴스를 시작함
- 이 인스턴스는 변환 작업을 수행하는 작업 인스턴스 역할을 함

<br>

#### 2. X.509 프라이빗 키 업로드

- S3-backed AMI를 번들링할 때 사용했던 X.509 개인 키를 변환 인스턴스로 업로드함
- 이 키는 AMI 번들 액세스/해독에 필요함

<br>

#### 3. AWS CLI 환경 변수 설정

- EC2 변환 작업을 수행할 IAM 사용자 자격 증명을 환경 변수로 설정함

```bash
export AWS_ACCESS_KEY_ID=your_access_key_id
export AWS_SECRET_ACCESS_KEY=your_secret_access_key
export AWS_SESSION_TOKEN=your_session_token
```

<br>

#### 4. 빈 EBS 볼륨 생성 및 연결

- 변환할 AMI의 루트 볼륨 크기보다 같거나 큰 EBS 볼륨을 생성함

```bash
aws ec2 create-volume --size 10 --region us-west-2 --availability-zone us-west-2b
```

- 작업 인스턴스에 이 볼륨을 연결

<br>

#### 5. AMI 번들 다운로드 및 언번들 (Unbundle)

- 임시 디렉터리를 생성하고 AMI 번들을 ec2-download-bundle 명령으로 다운로드함
- ec2-unbundle 명령으로 S3-backed AMI 번들을 풀어서 로컬 이미지 파일로 재구성함

<br>

#### 6. EBS 볼륨으로 이미지 복사

- `/tmp/bundle/image` 등 번들로부터 생성된 이미지 파일을 dd 명령으로 EBS 볼륨에 copy 함

```bash
sudo dd if=/tmp/bundle/image of=/dev/sdb bs=1M
```

- 이후 파티션을 인식시키고 (`partprobe`) 적절히 마운트하여 필요시 `/etc/fstab` 같은 설정을 조정함

<br>

#### 7. 새 EBS 볼륨 분리 및 AMI 생성 준비

- EBS 볼륨에서 불필요한 인스턴스 스토어 항목 등 설정을 제거함
- 볼륨 언마운트하고 분리함

<br>

#### 8. EBS 스냅샷 생성

```bash
aws ec2 create-snapshot --volume-id vol-01234567890abcdef --description "your_snapshot_description"
```

- 스냅샷이 완전히 생성될 때까지 기다림

<br>

#### 9. 새 AMI 등록

- 원래 AMI의 아키텍처, 가상화 유형, 커널 정보를 확인함
- 스냅샷 ID 및 확인된 정보로 새 AMI를 등록

```bash
aws ec2 register-image \
    --name "your_new_ami_name" \
    --block-device-mappings DeviceName=device-name,Ebs={SnapshotId=snap-01234567890abcdef} \
    --virtualization-type paravirtual \
    --architecture x86_64 \
    --kernel-id aki-fc8f11cc \
    --root-device-name device-name
```

- 필요 시 ramdisk ID(`ari`)도 지정함

<br>

#### 10. 테스트 및 정리

- 새로 등록된 AMI로 인스턴스를 실행하여 동작을 확인할 수 있음
- 확인 후 변환 과정에서 생성한 임시 EBS 볼륨 삭제가 가능