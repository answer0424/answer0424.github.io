---
layout: post
title: EC2Launch v2와 함께 Windows Sysprep을 사용하여 AMI 생성
date: 2026-01-13 09:00:00 +09:00
categories: [AWS, EC2, AMI]
tags: [aws]
image:
    path: /assets/img/aws/AWS.png
---


## 개요

- Sysprep: Windows 이미지를 일반화하여
  - 컴퓨터 이름, SID 등 고유 정보를 제거
  - 표준 AMI 템플릿을 생성하도록 하는 Microsoft 도구
- EC2Launch v2: Windows Server 2016 이상 AMI에 기본 포함된 시작 에이전트로 Sysprep 호출 및 준비 자동화를 도와줌

<br>

## Sysprep 작업 흐름

#### 1. Sysprep 호출

- EC2Launch 설정에서 Shutdown with Sysprep를 선택하면 `ec2launch sysprep` 명령이 실행됨

<br>

#### 2. 사전 설정 변경

- `unattend.xml` 설정에서 로케일 정보를 읽고 ➡️ `HKEY_USERS\.DEFAULT\Control Panel\International\LocaleName` 레지스트리를 편집

<br>

#### 3. RDP 비활성화

- `BeforeSysprep.cmd` 스크립트를 통해 ➡️ RDP 연결을 비활성화하여 Sysprep 중 충돌 방지

<br>

#### 4. Sysprep 실행

```bash
sysprep.exe /oobe /generalize /shutdown /unattend:"C:\ProgramData\Amazon\EC2Launch\sysprep\unattend.xml"
```

- 일반화 + OOBE + 종료 순으로 실행됨

<hr>

## Sysprep 단계별 공식 설명

#### 1. 일반화 (Generalize)

- 컴퓨터 이름, SID 등의 공유 정보 제거
- 도메인 멤버인 경우 도메인에서 제거
- 불필요 디바이스 정보 정리

- 관련 설정 예:
  - `PersistAllDeviceInstalls` ➡️ 장치 재검색 제한
  - `DoNotCleanUpNonPresentDevices` ➡️ 미존재 장비 정보 유지

<br>

#### 2. 특수화 (Specialize)

- `CopyProfile`
  - 기본 관리자 프로파일을 커스텀 프로파일로 복사
  - `True`일 경우, AMI를 통해 생성된 인스턴스에 동일한 프로파일 적용
- 관리자 계정 활성화 및 암호 설정
  - 자동으로 관리자 계정 활성화
  - 임의 암호를 생성하고 설정함

<br>

#### 3. OOBE (Out-of-Box Experience)

- Sysprep 이후 첫 부팅에서 적용되는 설정들

| 항목 | 설명 |
|-|-|
| `<InputLocale>` | 키보드 입력 로케일 |
| `<SystemLocale>` | 시스템 로케일 |
| `<UILanguage>` | UI 언어 |
| `<TimeZone>` | 시간대 |
| `<HideEULAPage>` | EULA 페이지 숨기기 |
| `<ProtectYourPC>` | 자동 업데이트 설정 |
| 기타 | Amazon/EC2 기본 값 설정 |

- 기본 설정은 대부분 `en-US`, 표준 Windows 환경 기반으로 되어 있음

<hr>

## Sysprep 완료 후 자동 작업

1. EC2Launch 구성 파일에 기반한 작업 실행
2. `preReady` 스테이지 실행
3. 시스템 로그에 `Windows is ready` 메시지 출력
4. `PostReady` 스테이지 실행

<hr>

## 실행 가이드

1. AWS 콘솔에서 기준 Windows AMI를 선택
2. 인스턴스를 실행 및 연결
3. AWS EC2Launch 설정 실행
4. Windows 환경을 필요에 따라 커스터마이즈
5. Shutdown with Sysprep 선택
6. Sysprep이 실행되고, 인스턴스가 Stopped 상태로 변경됨
7. 이 시점에서 AMI 생성 가능

<hr>

## Sysprep의 사용 이유

- SID/컴퓨터 이름 제거
- 로케일/시간대 등 표준 설정 구성
- 자동 로그인 방지
- 새 인스턴스를 처음 부팅 상태로 생성