---
layout: post
title: EC2Config와 함께 Windows Sysprep을 사용하여 AMI 생성
date: 2026-01-14 09:00:00 +09:00
categories: [AWS, EC2, AMI, Sysprep]
tags: [aws]
image:
    path: /assets/img/aws/AWS.png
---

## Sysprep 이란?

- Sysprep(System Preparation Tool)은 Microsoft 제공 도구로, Windows 인스턴스를 일반환 하여 **컴퓨터 이름**, **보안 식별자**, **도메인 회원 정보** 등 고유 정보를 제거함으로써 재사용 가능한 AMI 이미지를 만들기 위해 OS를 초기화함

> Sysprep은 백업 용도로 사용하면 안됨
>
> 시스템 고유 정보를 제거하기 때문에 백업 대상 인스턴스 복사본으로 복원하면 원치 않는 결과가 발생할 수 있음
{: prompt-warning }

<hr>

## EC2Config 서비스 역할

#### 1. Sysprep 실행 트리거

- EC2 서비스 속성에서 Sysprep을 이용해서 종료를 선택하면 EC2Config는 다음 명령으로 Sysprep을 호출함

```bash
ec2config.exe -sysprep
```

<br>

#### 2. 설정 파일 로드

- EC2Config는 `BundleConfig.xml` 설정을 로드함
- 이 파일의 설정 
  - AutoSysprep: Sysprep 자동 실행 여부
  - SetRDPCertificate: 자체 서명 RDP 인증서 설정 여부
  - SetPasswordAfterSysprep: Sysprep 후 무작위 관리자 암호 생성 여부
  - PreSysprepRunCmd: Sysprep 직전 실행할 커맨드 스크립트 경로

<br>

#### 3. RDP 비활성화

- `BeforeSysprep.cmd` 스크립트가 실행되어 Sysprep 중 RDP 연결을 비활성화함

<br>

#### 4. Sysprep 호출

```bash
sysprep.exe /unattend:"C:\Program Files\Amazon\Ec2ConfigService\sysprep2008.xml" /oobe /generalize /shutdown
```

<hr>

## Sysprep 이후 EC2Config 작업

1. `config.xml` 로드
2. Before Windows is ready 플러그인 실행
3. 시스템 로그에 `Window is ready` 출력
4. After Windows is ready 플러그인 실행

## Sysprep 실행 절차

1. EC2 콘솔에서 Windows AMI 선택
2. 인스턴스를 실행 및 사용자 지정
3. EC2Config 설정 파일(`sysprep2008.xml`) 위치 지정
4. Windows 시작 메뉴 ➡️ EC2ConfigService 설정
5. 관리자 암호 옵션 선택
   - `Random`: 무작위 암호 생성
   - `Specify`: 지정 암호 설정
   - `Existing`: 기존 암호 유지
6. Shutdown with Sysprep 선택
7. Sysprep 실행 ➡️ 인스턴스 Stopped 상태
8. 이 시점에서 AMI 생성 가능

<hr>

## 명령줄로 Sysprep 실행

```bash
"%programfiles%\amazon\ec2configservice\ec2config.exe" -sysprep
```