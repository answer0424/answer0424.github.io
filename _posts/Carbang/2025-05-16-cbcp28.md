---
layout: post
title: VES Thread (1)
date: 2025-05-16  13:00 +09:00
categoties: [cbcp, week07]
tags: [cbcp]
---

## VESEsProcThread.java

> 말소 처리 Thread
  
<br>

#### run()

- 말소 진행 상태 및 세부 진행 상태 별 처리 수행
- 01: 접수상태
- 04: 등록 준비 상태
- 07: 등록 불가 상태
- 08: 등록 취소 상태
- 09: 등록 완료 상태

<br>

#### strHypcErasReg()

> 신청 정보 확인 ➡️ 소유자 구분 확인 ➡️ 비즈톡 발송 ➡️ 소유자 일치 여부 확인 ➡️ 진행 상태 코드 업데이트

- 소유자 정보 확인
- 등록원부 대신 인카스 제한사항 조회
- 설정 금액 및 설정 일자 확인 -> 없으면 기존 설정 테이블에서 조회
- 소유자 불일치 및 소유자명에 (주), ㈜ 포함 시 재조회
- 인카스 제한사항 조회 연계 대신 기 조회된 차량등록원부를 통한 제한사항 조회 메소드 호출
- 판매상사이면 말소 비용 업데이트
- 소유자일치 시 말소대상건 존재여부 확인

<br>

#### rspsStgupRslt()

> 저당권 말소처리 결과 전문 발송

- 결과 전문 작성 및 전송, 업데이트

<br>

#### erasBizTalkSndg()

> 소유자 앞 말소등록 처리 알림톡 발송

- 차량소유자 휴대전화번호, 메시지 내용 파라메터, 버튼 링크 파라메터 조회
- 말소 등록 비즈톡 발송
- 처리이력 입력 - 저당말소 시작 비즈톡 발송

<br>

#### getMrtgInfoList()

> 저당 내역 조회

- 을부 번호 및 차대번호 등을 조회
- 저당 내역 기 조회 여부 확인
- 조회결과 '0000' 조회 (정상)
- 을부 번호 조회
- 조회결과 'E901' 조회 (오류)
- 차량 등록원부 재요청

<br>

#### insertMrtgInfo()

> 저당 내역 입력

- 등록원부 을부 insert

<br>

#### chkErasExpRcvSt()

> 말소비용 입금여부 확인
>
> 00: 입금계좌 미발급
>
> 01: 개인 - 말소비용 미입금
>
> 02: 말소비용 입금완료
>
> 11: 판매상사 - 잔액 부족
>
> 12: 말소비용 잔액 충분

- 개인인지, 판매상사인지에 따라 진행 코드 상이하게 처리

<br>

#### rqstErasReg()

> 말소 등록 요청

- 현재시간과 운영단에 입력한 요청 가능 시간을 비교
- 요청 시간이 아닐 경우: 관공서 등록 요청 대기(0404), 등록진행중 코드, 익일신청으로 빠짐
- 요청 가능 시간일 경우: 기 등록요청 여부 확인, 등록진행중 코드, 관동서 등록 요청(0403)
- 말소 신청 등록 결과 오류일 경우: 관공서 등록 오류(0405)

<br>

#### sacSlcoExp()

> 판매상사 비용 정산

- 누적 사용 금액 갱신
- 비용 지불: 잔액과 누적 사용 금액을 통해 비용 지불
- 비용 원복: 누적금액 추가건인지, 잔액 부족인지 등 확인

<br>

#### doErasRqstProc()

> 말소 등록 요청 처리 진행
>
> 전제조건: 소유자 일치 / 말소처리 대상 저당 존재
>
> 수행내역: 비용입금현황 확인, 입금완료상태이면 관공서 등록 요청

- 소유자 구분 확인: 03- 판매상상 그외 개인 또는 법인, 기타(09)는 개인/법인 미확인 시
- 말소 비용 입금 여부 체크
- 가상 계좌번호 오픈 요청 및 입금 대기 - 개인

<br>

#### doErasStopProc()

> 말소처리 업무 중지 처리
>
> 말소처리 대상 저당건이 없는 경우 등록불가(07), 기한만료(08, 0899)

- 소유자구분 확인: 03-판매상사, 그외 개인 또는 법인, 기타(09)는 개인/법인 미확인 시
- 대행서비스 관리 테이블 상태정보 업데이트
- 저당 말소 관리 내역 업데이트
- 진행상태 정보 고객사 전송
- 판매상사이면 말소 비용 원복
- 개인/법인
- 처리이력 입력 - 말소취소/불가처리

<br>

#### updateMrtgErasRslt()

> 말소 결과 정보 업데이트 : IDC에서 호출

- 대행서비스 관리번호 체크
- 등록결과 정보 설정: 정상
  - 저당 건수 조회, 대행 수수료, 말소 결과
  - 인카스 소유자 확인을 통해 실제 저당해지 처리가 되었는지 확인 -> 저당이 존재하면 복수개 저당 건이라도 진행상태를 05/0506으로 변경
  - 인카스 소유자 확인 연계: 오류
    - limtMttrMap가 null인 경우 이력 입력을 위한 처리
    - 인카스 소유자 확인 연계 오류 이력
- 등록 결과 정보 설정: 오류
  - 등록불가, 진행중(등록오류), 특이사항 저장
- 대행 서비스 관리 테이블 진행상태 업데이트
- 말소내역 업데이트
- 처리이력 입력 - 저당권 말소 등록 결과

<br>

#### chkVhclRegLdg

> 당일 등록 원부 정상조회 건 존재 여부 확인
>
> 01: 존재
>
> 02: 미존재

- 저당 말소 요청정보 조회
- 당일 차량등록원부 정상조회 건수 조회

<br>

## VESIqProcThread.jave

> 차량 조합 정보 조회 Thread

<br>

#### run()

- 당일 기 조회 여부 확인
- 재조회
  - 기존 차량 조회 정보로 대체
  - 직전차량번호 추가
  - 사고이력조회 여부 설정이면 사고이력조회 실행
  - 차량 분석 결과 업데이트
  - 차량종합정보결과 구분 코드 업데이트
  - 결과 전문 작성
- 신규조회
  - 차량 등록원부 조회 시 조회 프로그램 추가
  - 차량등록원부 조회 신 API 적용
  - 차량등록원부 테이블에서 조회
  - 차량 등록원부 조회 성공 시 
    - 차량 분석 결과 저장 성공 시 결과 업데이트(09)
    - 차량 분석 결과 저장 실패 시 결과 업데이트(07)
  - 차량 분석 결과 오류
    - 조회 실패 또는 민원 폭주일 경우 재조회
      - 차량 등록원부 전체 조회
      - 말소차량인 경우 차량 번호가 말소된 차량
      - 등록원부 재조회
      - 조회 성공 시 성공코드 업데이트
      - 조회 실패 시 실패코드 업데이트
    - 재조회 실패 시
      - 소유자 불일치의 경우 결과코드 및 특이사항 메시지 수정
      - 말소차량 특이사항 별도 처리
  - 소유자 불일치 또는 조회결과 없음
    -  결과메시지에서 [] 내용 삭제 : "[parts] [B7001-004] 조회결과없음" => "조회결과없음"
- 사고이력 조회 여부 설정 이면 사고 이력 조회 실행

<br>

#### saveInqRslt()

> 차량등록원부 조회 결과 저장

- resultMap에 대행 서비스 관리번호 추가
- 갑부내역 resultMap에 복사
- 제한사항 조회
- 말소구분 설정
- `CHECK_EXP_DATE`에서 검사유효시작/종료 일자 및 주행거리 추출
- 국산/수입구분명 설정
- 부활차 여부
- 제한사항 조회 for 공동명의여부 확인
- 을부 상세 리스트 조회
- 차량 종합 정보 관리 테이블 update(나이스디앤알 결과)
- 압류정보 추출, 주행거리, 이전 영업용 여부, 이전등록일, 직전차량번호, 직전차량번호 case2, 번호판영치여부, 번호판 영치 최고일, 구조변경여부, 용도변경여부 조회 결과 저장
- 판매상사소유 차량 자동차 종합정보 조회
  - 국산/수입 구분명 설정
  - 성능점검리스트 추출
  - 구조변경여부(불법) 확인

<br>

#### getAttcInfo()

> 정규식을 통해 자동차 등록원부 갑지 사항란 압류 촉탁 항목 파싱

- 구분, 촉탁기관, 압류관리번호, 압류내역, 촉탁일자


<br>

#### findPtrnTxt()

> 문자열에서 특정 패턴의 문자열 검색

<br>

## VESMvProcThread

> 시세 조회 및 결과 전송 Thread

<br>

#### run()

- 조건에 따라 시세 조회 프로세스 실행

<br>

#### doStCd01Proc

> 시세 조회

- 시세조회
- 접수번호를 통해 자동차 시세 정보 요청 처리 메서드 호출
- 결과 전문 전송
- 전송 결과 업데이트