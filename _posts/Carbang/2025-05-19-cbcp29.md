---
layout: post
title: VES Thread (2)
date: 2025-05-19  09:00 +09:00
categoties: [cbcp, week08]
tags: [cbcp]
---

## VESOtProcThread

> 소유권 이전 처리 Thread

<br>

#### run()

- 대행 서비스 관리 번호, 서비스 진행 상태 코드, 상세 진행 상태 코드, 결과 전송 상태 코드에 대한 변수 선언
- 대행 서비스 관리 번호가 존재할 경우 `procMedYn` 컬럼에 `Y` 추가
- 접수완료 상태일 경우
  - 소유자명 확인
  - 차량 등록원부 정상 조회 여부 확인 
  - 건수가 실제로 존재할 경우
    - 계양구청 앞으로 이전 등록 요청 수행
- 양도인 인증 대기 상태일 경우
  - 양도인 인증실패 오류건 -> 관리 화면에서 처리
  - 소유권 이전 정보 조회
  - 차량 부선 미실행의 경우 차량분석 진행 후 재조회
  - 화물차 여부 확인
    - 등록불가
  - 인증 미요청
    - 인증 재요청
    - 메인 테이블 진행상태 업데이트
- 인증 대기
- 인증 처리완료
  - 진행 상태 코드 `등록진행중` 업데이트
  - 처리이력 입력
  - 알림톡 발송
- 양도인 인증기한 만료
  - 진행상태코드, 세부진행 상태 코드를 업데이트
- 인증 신청오류
  - 상태 변경 없이 대기, 관리화면에서 조치 
- 등록 진행 중
  - 소유권 이전 정보 조회
  - 차량 분석 실행 여부 확인
  - 차량 분석 이실행일 경우 차량 분석 실행
- 양수인이 법인일 경우
  - 법인 본사 주소 조회
- 양수인 인증 대기
  - 인증 상태 확인
  - 카카오페이 인증 상태 확인
- 양수인 인증 완료
  - 현재시간과 운영단에 입력한 요청 가능 시간을 비교
  - 비용 중복 계산 방지, 가상 계좌정보 확인해서 없을 때만 비용 계산
    - 비용 산출 기준 시각 조회
      - 비용 산출 vesService로 전환
    - 가상 계좌 발급
      - 성공 시 고객사 앞으로 갱신된 비용 정보 전송
    - 법인인증 완료 안내 비즈톡 발송
- 양수인 인증 신청 오류
  - 진행 상태 업데이트
- 등록 비용 입금 대기
  - 비용 입금 여부 확인
  - 비용 입금이 되었으면 다음 진행 상태로 이동
    - 소유권 이전 등록 요청
    - 진행 상태 코드 업데이트
    - 진행 상태 정보 고객사 전송
  - 이전 비용 미 입금 상태
    - 이전 만료일시 경과 여부 확인
    - 진행 상태 및 상세 진행 상태 코드 (등록취소) 업데이트
  - 이전 비용 산출 상태 코드 조회
  - 관공서 등록 요청
    - IDC로부터 과세 결과 응답 대기
  - 관공서 등록 요청 대기(익일 예정)
    - 현재 시간과 운영단에 입력한 의뢰시간으로 비교
    - 등록 가능한 시간인지 확인
    - 소유권이전 등록 요청
    - 진행 상태 코드 `0404`와 다를 경우
  - 관공서 등록 요청 오류
    - 운영 관리에서 담당자가 처리
    - 과세 결과 상이
  - 확인 및 재처리
    - 인증 신청 오류
- 등록 불가
  - 진행상태정보전송 전문 발송
- 등록 취소
  - 고객입금비용 계좌신청번호가 존재하면 해당 가상계좌 삭제
  - 등록 취소 사유에 대한 조건문 (코드가 상이함)
- 등록 완료
  - 진행상태코드 업데이트
  - 소유권이전 정보 조회
  - 결과 전송 여부 확인 (미전송일 때만 결과 전송)
  - 소유권 이전 처리완료 비즈톡 발송
  - 비용 납부 상태 확인 후 미입력 시 통합비용납부 테이블 입력
  - 채권 관리 테이블 입력
- 과세 결과 처리
  - 이전 완료가 되었다면 이전의 자동차 등록원부는 재사용할 수 없어야 함

<br>

#### strOwnsTfrReg()

> 소유권 이전 등록 시작

- 소유권 이전 요청 정보 조회
- 소유자명 확인
- 양수인 주민번호 확인
- 양수인/양도인 동일여부 체크
- 양수인 사업자 번호 확인
  - 법인 and 사업자 번호 길이 오류 -> 등록 불가
- 양수인이 법인인 경우
  - 법인주소 조회
    법인이라면 대리인 휴대전화 번호 설정
- 양수인이 외국인이라면 -> 등록불가 처리
- 판매상사용 차량이라면 -> 등록불가 처리
- 소유자 일치여부 및 저당, 압류, 제한항 확인 -> 인카스
- 제한사항 간편조회 실패
  - 소유자 확인 자망 연계 실패
- 소유자명 일치
  - 기타 제한 사항 체크
  - 압류 존재 여부 확인
  - 말소 차량 여부 확인
- 소유자 불일치
- 소유자 확인 및 제한사항 오류일 경우
- 제한 사항 오류가 아닐 경우
  - 녹색 번호판 교체 대상 여부 확인
  - 화물차 여부 확인
- 진행 상태 정보 고객사 전송

<br>

#### otStartBizTalkSndgg()

> 양수인 앞 소유권 이전 시작 알림톡

- 양수인 휴대폰번호 저장
- 소유권 이전 알림톡 발송

<br>

#### getVhclOwnrNm()

> 차량소유자명 조회 및 DB 업데이트

- 차량 소유자명 설정
- DB 업데이트 준비
  - `paramMap`을 생성하고, `vesxSvcMgntNo`와 `vhclOwnrNm`을 넣음
  - `updateOwnsTrfnInfo()를 통해 DB 업데이트를 수행
- 예외 처리
- 조회된 소유자명 반환

<br>

#### doVhclAnal()

> 소유권 이전 진행 전 차량 분석 수행

- 차량 번호와 소유자명을 변수에 저장
- 등록원부 조회
  -  `selectVhclRegLdgBase` 호출
-  조회 성공 분기
   -  JSON 데이터를 `GSON`으로 변경
   - 차량종합정보 관리내역 삽입
   - 소유권 이전 내역에  차명, 차대번호 등 업데이트
 - 차량 분석 결과 업데이트
 - 처리 이력 기록
 - `bRtn = true`
 - 조회 실패 분기
 - 전체 예외 처리
 - 메서드 종료 로깅 및 반환

<br>

#### chkSignSt()

> 양도증명서 인증 상태를 조회하고 인증 상태에 따라 인증 관리 테이블을 갱신하며, 이후 진행 상태 코드를 반환
>
> 주요대상: 양수인 인증 상태 체크
>
> 특이사항: 인증 방식(카카오페이, SCI 본인인증 등)에 따라 처리 로직 분기

- 입력값 검증
- 기존 인증 요청 정보 조회
  - `대행관리 번호`와 `인증대상자구분`를 조건으로 인증 정보 조회
- 기존 인증 요청 정보가 있을 경우
  - `인증진행상태코드`와 `인증방법코드`를 기준으로 분기 처리
  - 인증 진행 상태가 `01`일 경우
    - 카카오페이 인증일 경우
      - Kakao 인증 상태 API 호출
    - SCI 본인 인증일 경우
      - 인증 만료 시간 확인
  - 인증 상태별 정적 처리
    - 인증 완료(`02`): 진행상태코드(`04_02`)
    - 인증 호류(`03`): 진행상태코드(`08_99`)
    - 인증 기한 만료(`04`): 진행상태코드(`08_03`)
    - 미인증: 진행상태 없음
- 인증 요청 정보가 없는 경우
  - `tfrnExpryDtm`을 기준으로 인증만료 체크

<br>

#### rqstOwnsTfrnReg()

> 소유권 이전 신청

- 입력 검증 및 로그 시작
- 요청 가능 시간 체크
- 기초 데이터 준비
  - `selectRqstTmYn`을 호출하여 등록 가능 여부 확인
  - `Y`가 아니면, `VES_PRGS_ST_CD_04_04` 반환
- 기초 데이터 준비
- 인증 요청번호 및 확인 조회
- 요청 데이터 구성
- 외부 인터페이스 요청
- 결과 저장
- 예외 처리
- 종료 프로그램 및 상태코드 반환

<br>

#### rspsOtRslt()

> 소유권이전 처리결과 전문 전송

- 초기 설정 및 로그 시작
- 상세업무코드 결정
  - `rsltCd`가 `VES_RSLT_PRGR_OT`인 경우 -> 진행 상태 정보 전송
  - 그 외 -> 등록결과 전송
- 전문 생성
  - `vesTmsgValidator.wrtgSndgTmsg` 호출로 결과 전문 메시지 생성
- 전송 대상 URL 결정
- 전문 전송 및 응답 수신
  - `VESUtil.rspsProcRslt` 호출
- 전송 결과 업데이트
- 예외 처리

<br>

#### rspsOtRslt()

> 채권 구매 정보 입력

- 로그 시작 출력
- `rsltCd`에 따라 상세업무코드 설정
- `vesTmsgValidator.wrtgSndgTmsg` 호출로 전송 전문 생성
- 전송 대상 URL 결정 
- `VESUtil.rspsProcRslt`호출로 전문 전송 및 응답 수신
- `rsltCd`가 특정 보건일 경우 이력 및 업데이트 생략

<br>

#### sndExpPtclTmsg()

> 비용내역 고객사앞 재전송
>
> 진행 상태 및 비용 전송 이력이 없는 경우에만 고객사에 전송하며, 전송 후 이력 테이블에 기록

- 로그 시작 출력
- 입력 검증
- 핵심 파라미터 추출
- 비용 전송 여부 확인
  - 이미 전송된 경우 아무 동작 없음
- 진행 상태 전송 여부 확인 전송
  - `0402` 결과가 아니면 `vesService.trmsPrgrStInfo()` 호출로 고객사에 현재 상태 전송
- 이전 비용 정보 전송
- 처리 이력 저장
- 예외 발생 시 로그만 남기고 무시
- 로그 종료 출력

<br>

#### chkExpClcSt()

> 이전비용 산출 상태 조회
>
> 소유권 이전 비용의 산출 상태를 확인하여 유효성 코드를 반환

- 메서드 시작 로그 출력
- 파라미터 유효성 검증
- 기본값 설정
- 기본 팔아미터 설정 및 현재 일시 계산
- DB 조회
  - `selectLstExpTgtDt`: 이전 비용 최종 산출일자 정보
  - `selectRqstTmYn`: 당일 이전 비용 유효 여부
- 판단 로직
  - 1. 비용 산출 내역이 없다면
  - 2. 유효한 시간대(06~16시) 이내라면
  - 3. 유효하지 않은 시간대 (06~16시) 이외라면

<br>

#### getExpTgtDt()

> 비용대상일자 조회

- 현재일시 계산 및 분리
- 기준 시각(`bascTm`) 비교 처리
- `procDt`의 영업일 여부 조회
- 영업일 여부에 따른 비용 대상일자 설정

<br>

#### getBoncBaseDt()

> 채권 기준일자를 조회

- 현재 일시 계산
- 기준 시각 이전 여부 판단
- 영업일 정보 조회
- 영업일 여부에 따른 기준일자 설정

<br>

#### chkCrpnCertSt()

> 법인인증상태 조회

- 인증 요청 정보 조회
  - 인증정보가 없으면 만료 여부만 체크하려 필요 시 `08_03`을 반환
- 인증 요청 정보가 있을 때 
  - 인증 진행 상태에 따라 달리 처리
- 인증 요청 정보가 없을 때
  - `tfrnExpryDtm`로부터 만료 시각 계산

<br>

#### chckInstnValdTrm()

> 자동차 정기검사 유효만료일자를 체크하여 경과 시 등록 불가 처리 및 알림톡 발송 수행

- 입력값 검증
- 서비스관리번호, 검사 유효만료일자 추출
- 검사 유효만료일자 없는 경우 처리
  - 상태코드: `05(확인 및 재처리)`, `0502(세부 상태)`
  - 확인 구분코드: `100`
  - 메인테이블 상태 업데이트
  - 처리이력 기록
- 유효 만료 일자 비교
- 정상인 경우
  - 리턴 `true`

<br>

#### getTaxtStdAmt()

> 대행서비스관리번호 기준으로 차량 정보를 조회하고 이를 바탕으로 시가표준액을 계산

- 입력값 체크
  - ` vcexSvcMgntNo`가 비어있으면 `-1`을 반환
- 차량 정보 조회
  - `selectVhclInfoForCalcExp()` 호출하여 차량정보(Map) 획득
- 국산/수입 구분명 처리
- 시가표준액 조회
  - `estTaxtStdAmt()` 호출하여 금액 조회
- 예외 처리

<br>

## VESRegLdgInqThread

> 차량 번호 및 차량 소유자명을 기준으로 차량등록원부 정보를 조회하는 비동기 스레드
>
> 핵심 기능
>
>> 등록원부 조회 요청
>>  
>> 처리 결과 이력 저장
>>
>> 스레드 로깅을 위한 `ThreadContext` 설정 및 정리

- 입력 파라미터 확인
  - `jobInfoMap`은 스레드 생성자에서 전달된 Map
  - 차량 등록원부 조회를 위해 필요한 기본 정보 추출
- 로그 Context 업데이트
- 등록원부 조회 요청(`VESUtil` 호출)
  - 차량등록원부를 외부 또는 내부 시스템에 조회 요청
  - `VESUtil.inqVhclRegLdg`는 실제 요청 처리 로직이 들어간 유틸 메서드
- 처리 이력 등록
- 예외 처리

<br>

## VESPotProcThread

> 소유권 이전 처리 Thread

<br>

#### run()

- 등록 요청
- 접수 완료 상태
  - 소유권 이전 시작 메서드 호출
- 등록 준비 중
  - 차량 분석 실행여부를 확인하고 차량 분석 실행
  -  화물차 여부 확인 ➡️ 화물차일 경우 등록 불가
  -  양수인 양도인 인증 상태 확인
  -  인증 상태에 따른 처리 상태 조회
-  등록비용 입금 대기
  - 이전등록 비용 계산을 위한 비용 산출 기준 시각 조회
  - calcOtExp 메서드를 호출해 비용 산출 
  - 비용 산출이 문제없이 되면 가상 계좌 발급
  - 재휴사 코드로 거래처 조회 
  - 양수인 양도인 인증 기한 만료일 경우
    - `spclMttr`에 인증기한 만료 코드 저장
  - 인증 신청 오류
    - `spclMttr`에 인증신청 오류 코드 저장
    - 양도인 양수인 인증 대기 중이 아니라면 `updateVcexSvcMgntBase` 메서드 호출
  - 등록 진행 중
    - 소유권 이전 정보 조회
    - 제휴사 코드 확인
    - 차량 분석 실행 여부 확인
    - 차량 분석 미 실행일 경우 재조회
    - 화물차 여부 확인
    - 양도인 인증 대기 상태
      - 인증 완료 시 처리 결과, 처리업무구분 코드 변경
      - 현재 시간관 운영단에 입력한 요청가능을 시간으로 비교
        - 이전 등록 비용 계산
    - 양수인 인증 대기 상태
      - 인증 완료 시 처리 결과, 처리업무구분 코드 변경
      - 현재 시간관 운영단에 입력한 요청가능을 시간으로 비교
        - 이전 등록 비용 계산
    - 등록 비용 입금 대기 상태
      - 비용입금여부 확인
      - 비용 입금 시 등록요청으로 이동
    - 소유권 이전 등록 요청(등록요청이 가능한 시간이 아니면 익일신청대기로 리턴)
    - 이전 비용 미입금 상태
      - 등록취소, 등록비용 미입금 등록취소로 상태 업데이트
      - 당일 이전 비용이 유효하지 않으면 비용 산출
        - 가상 계좌 발급
    - 관공서 등록 요청
    - 관공서 등록요청 대기(익일 예정)
      - 현재시간과 운영단에 입력한 의뢰시간을 비교
    - 관공서 등록요청 오류
    - 과세결과 상이 
- 확인 및 재처리
  - 인증 신청 오류
    - 플래그가 `Y`이면 인증 재요청
- 등록 불가 상태
  - 최종 처리결과 전문 발송
- 등록 취소 상태
  - 이전채널이 TS인 기한만료 취소건의 경우 오전 9시 이후 처리하도록 skip 처리
  - 고객입금비용 계좌 신청번호가 존재하면 해당 가상 계좌 삭제
  - 취소 사유에 따른 조건문을 통해 해당 코드 리턴
  - 이전 취소 비즈톡 발송
    - url 선언
    - 법인의 경우 대리인 휴대전화번호로 수신번호 교체
    - `vesBizTalkSndg` 메서드 호출하여 비즈톡 발송
  - 보험 미가입 취소일 경우
    - 양수인에게 보험가입 비즈톡 추가 발송
- 등록 완료 상태
  - 결과 전송 여부 체크 ➡️ 미전송의 경우에만 결과 전송
  - 이전채널이 TS인 경우, 완료 비즈톡 발신 시점을 결과 전문 수신 시점으로 변경
  - 비용납부 상태 확인 후 입력 시 통합 비용 납부 테이블 입력
  - 채권 관리 테이블 입력
- 등록결과 업데이트(과세 결과)
  - 등록 기관리 인천계양구청이면서, 등록완료 상태인 경우 과세 결과 정보 업데이트 시 상태를 등록완료로 변경

<br>

#### strOwnsTfrnReg()

> 소유권 이전 등록 시작

- 소유권이전 요청정보 조회
- 양수인 주민(법인)번호 확인
- 양수인/양도인 동일 여부 체크
- 양수인 외국인 여부 확인 ➡️ 등록불가
- 양도인 외국인 여부 확인 ➡️ 등록불가
- 판매상사용 차량 ➡️ 등록불가
- 차량 분석 실행 여부 초기화 후 실행여부 확인 후 실행
- 등록원부 제한사항 조회로 수정
- 소유자명 일치 
  - 기타제한사항 확인
  - 압류존재 확인
  - 말소차량 확인
  - 모두 pass일 경우 정상 코드 리턴
  - 소유자확인 및 제한사항 오류일 경우 즉시 종료
  - 오류가 아닐 경우 화물차 여부인지 한번더 확인
    - 화물차일 경우 ➡️ 등록불가
    - 아닐 경우 ➡️ 양도인/양수인 인증대기

<br>

#### setTfrnExpryDtm()

> 소유권 이전 등록기한 만료일시 설정

- 이전등록 기한 만료일 계산: 해지일자 기준 15일 후
- 만료일이 휴일인지 확인
  - 휴일의 경우 익영업일로 설정

<br>

#### chkSignSt()

> 양도증명서 인증 상태 조회

- 인증요청 정보 존재할 경우
  - 인증대기
    - 인증방법 (카카오페이)
      - `getKakaoCertStatus` 호출
      - 전자서명상태코드: 인증완료, 기한만료, 인증대기
    - 인증방법 (법인인증)
      - `getCrpnCertSt` 호출
      - 법인인증 진행 상태코드
      - 전자서명상태코드: 인증완료, 기한만료, 인증대기
    - 인증방법 (전자서식)
      - `chkCertTmsg` 호출
      - 정상 응답 시 계약 발송 번호 추출
        - 02 코드
          - 정상 서명 완료
        - 01 코드
          - 현 단계에서는 별도 처리없고 무조건 미완료 전송
    - 인증방법 (SCI 본인인증)
      - `getCertExpryDtm` 호출
      - 이전 만기일자 확인
      - 인증 만료일시 초과 시
        - 인증진행 상태 변경
  - 인증 요청 정보 미존재 시 ➡️ 기한만료 별도 체크
    - 인증 만료일시 초과 시 인증진행상태 변경 (인증기한만료)
    - 인증 재요청
      - 인증대상자 설정
      - 인증 요청

<br>

#### getExpTgtDt()

> 비용 대상일자 조회
>
> 특정시간(16시) 이후이거나 당일이 휴일이면 다음 영업일 리턴

- 현재일시 추출
- `selectBussDayInfo` 메서드를 통해 영업일 확인
- 정상 영업일일 경우 비용 대상일자로 설정
- 휴일이면 익영업일을 비용대상일자로 설정

<br>

#### rspsOtRslt

> 소유권이전 처리결과 전문 전송

- 등록결과 전송
- 등록비용입금대기 정보 전송일 경우 `진행상태정보전송`으로 변경
- 소유권이전 결과 전문 작성

<br>

#### rqstOwnsTfrnReg()

> 소유권이전 신청

- TS 이전 신청 추가일 경우
  - 등록요청 가능시간 확인 아니면 pass
  - 양수인 인증완료 정보 조회
  - 양도신청번호 조회
  - 계약 발송 번호 조회
  - 수입인지번호 확인 인전 신청 이후 사용 처리
  - TS 인터페이스 이전신청 호출
  - 응답이 빈 채로 수신된 경우의 처리
    - ts 측으로부터 timeout으로 오류발생 메시지가 수신되었으나 실제로는 정상처리된 건이 존재하여, 이와 같은 상황을 대비해 해당 건을 재차 확인하도록 함
    - 민원신청 상태 정보 조회 호출(`rqstTfrnStCnfm`)
    - 정상접수로 판단(비용납부대기)
      - 수입인지 고유번호 저장
    - 비정상접수로 판단하여 취소처리 (관공서 등록 오류)
  - 요청 실패
    - 수입인지 미사용 처리 (`updateRstmpUseYn`)
  - 요청은 정상적으로 이루어졌으나, 이전신청이 불가(반려)
    - 수입인지 미사용 처리 (`updateRstmpUseYn`)
  - 이전신청 정상
    - 이전 신청 관리번호, 카방관리번호, 이전등록신청 번호 추출 후 저장 (`updateTSTfrnApcMgntNo`)
- 계양 구청 이전 신청일 경우
  - 등록 요청 가능기간인지 확인
  - 이전 신청에 필요한 채권정보들을 가져옴
  - 채권매입은행, 채권 매도금액, 채권실채권금액 추출
  - 양도증명서 인증요청 시 신청번호 조회 (`selectCertRqstInfo`)
    - 신청정부번호, 양수인 인증확인 키, 양수인 인증완료 일시, 양수인 인증요청 정보, 양도인 인증확인 키, 양도인 인증완료 일시, 양도인 인증요청번호 추출
  - 양도인, 양수인 구분(개인 or 법인)
  - 판매상상 여부 조회 후 판매상사일 경우 `03` 아니면 `01`
  - 제휴사, 양도인 관리번호가 있을 때 판매상사용 양도증명서 작성을 위한 파라미터 추가
  - 판매상사일 경우
    - 관련 파라미터 추가

<br>

#### chkExpClcSt()

> 이전 비용 산출 상태 조회

- 이전 비용 최종산출일자 조회(`selectLstEcpTgtDt`)
- 당일 이전 비용 유효 여부 확인

<br>

#### insertBoncPch()

> 채권 구매 정보 입력

- 대행서비스 관리 번호 체크
- 기 입력 여부 체크(`selectBondPchInfo`)
- 등록 관청 과세정보 조회(`selectExpMgntBase`)
- 채권 금액 변수 변경
- 등록 지역명 조회(`selectOtExpMgntPtcl`)
- 채권구매채널 코드 조회(`setbondPchChnlCd`)
- 채권구매상태코드 설정
  - 구매지역이 인천 또는 이전채널이 TS인 경우 채권구매완료
  - 구매금액이 0인 경우 채권구매 면제
  - 채권 구매대기
- 채권구매관리 insert(`insertComBondPchMgntBase`)
- 채권 구매내역입력(`insertVcexSvcMgntHist`)
- 공채매입영수증 생성(`crePublnBuyVou`)

<br>

#### chkPrgrSt()

> 인증상태에 따른 진행상태 조회

- 인증상태 확인
- 양수인 인증대기, 양도인 인증대기
- 양수인 인증완료, 양도인 인증대기
- 양수인 인증대기, 양도인 인증완료
- 양수인 인증완료, 양도인 인증완료
- 인증 신청 오류 ➡️ 인증 불가 처리
- 인증 기한 만료 양수인 인증기한 만료
- 인증 기한 만료 양도인 인증기한 만료
- 등록 준비 (인증 대기 중)

<br>

#### getIndvOrCoprNumberDiv()

> 비즈톡 발송용 전화번호를 개인일 때는 본인 전화번호, 법인일 때는 대리인 휴대전화번호를 리턴하는 메서드

- 해당 디바이스가 양도인인지, 양수인인지 확인
- 개인/법인 검증