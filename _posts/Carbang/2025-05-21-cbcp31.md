---
layout: post
title: VES Thread (4)
date: 2025-05-21  09:00 +09:00
categoties: [cbcp, week08]
tags: [cbcp]
---

## VESSuProcThread

> 설정 처리 Thread

<br>

#### run()

- `procMedYn` 컬럼을 `Y`로 변경 (현재 스레드가 작업을 처리하고 있다는 뜻)
- 진행상태별 처리 수행(접수상태)
  - `strHypcStgupReg()` 호출
- 진행상태별 처리 수행(등록진행 중 상태)
  - 관공서 등록요청의 경우
    - IDC에서 과세 결과 확인 후 과게 완료되면 통지 전문 전송 (`VESController.updatreVesSvcRslt()`)
  - 관공서 등록요청대기(익일 예정)
    - 현재 시간이 운영단에 입력한 요청 가능한 시간임을 확인(`selectRqstTmYn`)
    - 등록 요청 가능 시간일 경우
      - 저당 설정 요청 정보 조회(`selectHypcStgupRqstInfo`)
      - 저당 설정 요청 (`rqstStgupReg()`) 호출
      - 관공서 등록 요청 이거나 관공서 등록 예정일 경우 ➡️ 진행상태정보 고객사 전송
  - 관공서 등록 오류 ➡️ 2가지 케이스 (등록요청 시 오류, 최종 과세 결과 수신 시 오류)
    - 등록 재요청 플래그가 `Y`이면 관공서 앞 재요청
    - 등록 가능한 시간인지 확인
      - 가능한 시간이라면 (`selectHypcStgupRqstInfo`)
      - 재요청 플래그 리셋 (`updateVcexSvcMgntBase`)
- 진행상태별 처리 수행(등록불가 상태)
  - 저당 설정 정보 조회(`selectHypcStgupMgntPtcl`)
  - 최종 진행상태정보전송 전문 전송(`trmsLstPrgrStInfo`)
- 진행상태별 처리 수행(등록취소 상태)
  - 저당 설정 정보 조회(`selectHypcStgupRqstInfo`)
  - 저당 설정 관리내역 업데이트(`updateHypcStgupMgntPtcl`)
  - 진행상태정보전송 전문 발송(`trmsLstPrgrStInfo`)
- 진행상태별 처리 수행(등록완료 상태)
  - 등록완료, 전문 내용 존재 여부에 따라 진행상태정보전송 전문 발송(`trmLstPrgrStInfo`)
  - 비용납부상태 확인(`selectExpPaySt`)
  - 설정정보조회(`selectHypcStgupMgntPtcl`)
  - 비용납부 테이블에 미입력된 상태일 경우 비용납부 테이블 입력(`insertUnfyRegExp`)
  - 당일 차량정보 조회 결과코드 무효처리(`updateVhclRegLdgRsltCd`)

<br>

#### strHypcStgupReg()

> 저당설정 요청 처리

- 저당설정 요청 정보 조회(`selectHypcStgupRqstInfo`)
- 소유자 확인 연계(`rqstOtsfIntfSvcByPost`)
- `8888` 코드 리턴 시
  - 소유자명 확인 실패 / 인카스 자망 연계 실패
- 소유자명 불일치 및 소유자명이 주식회사일 경우
  - 바꿔서 재조회
- 소유자 일치 여부 및 제한사항 확인(`insertVcexSvcMgntHist`)
- 소유자 불일치 시 (`updateVcexSvcMgntBase`) - 관공서 등록 오류
- 진행 상태 정보 고객사 전송(trmsPrgrStInfo`)
- 소유자일치 여부, 기 저당 존재 여부, 압류 존재 여부에 따라서 코드 저장
- 저당설정 불가 물건
  - 등록불가로 대행서비스 관리 테이블 상태정보 업데이트(`updateVcexSvcMgntBase`)
  - 저당 설정 관리 내역 업데이트(`updateHypcStgupMgntPtcl`)
  - 진행상태 정보 고객사 전송(`trmsPrgrStInfo`)
- 소유자 일치 및 설정등록 가능 물건
  - 저당설정 등록요청(`rqstStgupReg`)
  - 진행상태 고객사 전송(`trmsPrgrStInfo`)

<br>

#### rqstStgupReg()

> 저당설정 요청

- 현재시간과 운영단에 입력한 요청가능시간을 비교(`selectRqstTmYn`)
- 요청 가능 시간이 아닐 경우
  - 관공서 등록요청 대기(익일 신청) 설정
  - 대행서비스 관리 상태코드 업데이트(`updateVcexSvcMgntBase`)
  - 처리이력 입력(`insertVcexSvcMgntHist`)
- 요청 가능 시간일 경우
  - 저당권자 정보 설정
  - 차량 소유자가 판매상사일 경우 차량 소유자 인증정보를 판매상사 인증 정보로 대체
  - 응답요청 결과에 따른 결과 코드 설정
  - 대행서비스관리 상태 코드 업데이트(`updateVcexSvcMgntBase`)
  - 처리이력 입력(`insertVcexSvcMgntHist`)

<br>

#### rspsHypcStgupRslt()

> 저당설정 결과 응답 처리

- 저당 설정 결과 전문 작성(`wrtgSndgTmsg`)
- 처리결과 전문 전송(`rspsProcRslt`)
- 전송 결과 업데이트(`updateTrmsRslt`)

<br>

#### updateMrtgStgupRslt()

> 저당 결과 과세결과 업데이트

- 대행서비스관리 번호 확인(빈 값인지)
- 등록결과 정보 설정 - 정상
  - 정상값들 저장
- 등록결과 정보 설정 - 오류
  - 오류값들 저장
- 대행서비스 관리 테이블 진행상태 업데이트(`updateVcexSvcMgntBase`)
- 저당권 설정 내역 업데이트(`updateHypcStgupMgntPtcl`)
- 처리이력 입력 - 저당권설정 등록 결과(`insertVcexSvcMgntHist`)