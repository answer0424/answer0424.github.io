---
layout: post
title: 비즈니스 로직 (2)
date: 2025-05-26  09:00 +09:00
categoties: [cbcp, week09]
tags: [cbcp]
---

#### setVhclOvrInfo()

> TS 차량종합정보 조회결과 테이블 입력

- 차량분석 판매상사 기본 테이블 입력(`insertVhclAnalSlcoBase`)
- 차량분석 정비 이력 테이블 입력(`insertVhclAnalMtnHist`)
- 차량분석 성능내역 테이블 입력(`insertVhclAnalPermPtcl`)

<br>

#### insertVhclAnalSlcoBase()

> 차량분석 판매상사 기본 테이블 입력

- 차량분석 판매상사 기본 테이블 입력(`insertVhclAnalSlcoBase`)

<br>

#### insertVhclAnalMtnHist()

> 차량분석 정비이력 테이블 입력

- 정비이력 리스트 추출
- 정비이력 리스트가 존재할 경우
- 저장할 파라미터 추출 후 저장(`insertVhclAnalMtnHist`)

<br>

#### insertVhclAnalPermPtcl()

> 차량분석 성능내역 테이블 입력

- 성능점검 리스트 추출
- 성능정검 리스트가 존재할 경우
  - 복수 개 존재할 경우와 1건만 존재할 경우를 나눔
  - 저장할 파아미터 추출 후 저장(`insertVhclAnalPermPtcl`)\
- 차량분석 판매상사 기본 테이블의 용도변경여부 컬럼 업데이트(`updateVhclAnalSlcoBase`)


<br>

#### getInsuAcdtInfo()

> 보험사고정보 조회

- 차량번호 및 차량 소유자명 검증 ➡️ 누락 시 오류 리턴
- 차량분석 마스터 번호 존재하지 않을 경우
  - 신규(보험사고정보 조회)로 입력
  - 공통 차량 분석 마스터 테이블 입력(`insertVhclAnalMstr`)
- 보험사고정보 항상 조회 여부 확인(`getSysVrbs`)
- 당일 보험사고 조회 정보 확인(`selectLstInsuScssInfo`)
- 당일 기 조회 건 존재할 경우
  - 공통 차량분석 보험사고 기본 테이블 복사 입력(`copyVchlAnalInsuAcdtBase`)
  - 공통 보험사고 사고 정보내역 복사 입력(`copyComInsuAcdtInfoPtcl`)
  - 공통 보험사고 차량 정보 변경 내역 테이블 복사 입력(`copyInsuAcdtInfoUpdPtcl`)
  - 해당 키가 있고 그 값이 `Y`인 경우에만 알림 센터등록
    - 앱 내 알림센터 내역 입력(`insertComAlmiCntrPtcl`)
- 신규 조회 호출일 경우
  - 보험사고 내역 조회(`adctHistInqApiAllocator`)
  - 성공일 경우
    - 보험사고 정보 입력(`insertInsuAcdtInfo`)
    - 해당 키가 있고, 그 값이 `Y`인 경우에만 알림센터등록(`insertComAlmiCntrPtcl`)
  - 오류일 경우
    - 직전 차량 번호가 없으면 등록원부에서 직전차량번호 조회하도록 변경(`getJbfVhclNo`)
    - 직전차량번호 조회 성공 시 재조회(`acdtHistInqApiAllocator`)
    - 보험 사고 정보 조회 성공할 경우
      - 보험사고 정보 입력(`insertInsuAcdtInfo`)
      - 해당 키가 있고 그 값이 `Y`인 경우에만 알림 센터 등록(`insertComAlmiCntrPtcl`)
- 단독 조회일 경우 진행상태 업데이트(`updateVhclAnalMstr`)

<br>

#### insertInsuAcdtInfo()

> 보험사고 정보 입력

- 차량분석 보험사고 기본 테이블 입력을 위한 파라미터 저장
- 최초 자동차 정보 조회
- 주행거리정보 조회
- 첨단 안전 장치 장차 정보
- 차량분석 보험사고 기본 테이블 입력(`insertVhclAnalInsuAcdtBase`)
- 사고 내역 정보 테이블 입력을 위한 파라미터 추출
- 사고 내역 정보 테이블 입력(`insertComInsuAcdtInfoPtcl`)
- 사고 건수 및 보험금 합계 정보 추가
  - 내보험으로 사고 처리인 경우
    - `selfInsbfAmt`에 해당 값 추가
  - 상대발보험으로 사고 처리인 경우
    - `dmagAcdtAmt`에 해당 값 추가
- 사고 보험금 정보 업데이트(`updateAcdtInsbfAmtSum`)
- 차량번호 변경 이력 입력(`insertInsuAcdtVhclInfoUpdPtcl`)
- 소유자 변경 이력 입력(`insertInsuAcdtVhclInfoUpdPtcl`)

<br>

#### getInpDrveDstncApclMvPrc()

> 입력주행거리 적용 시세

- 공통시스템 변수 조회(`selectSysVrbsMgntBaseList`) ➡️ 입력 주행거리
- `CALC_MM` ➡️ 주행거리 계산 월 수
- `CALC_APCL_RT` ➡️ 주행거리 계산 적용율
- `AVG_DRVE_DSTNC` ➡️ 1달 평균 주행거리
- `MAX_DRVE_DSTNC` ➡️ 최대 주행거리
- 주행거리 적용율
- 경과년수 주행거리 설정
- 고객입력 주행거리 최대주행거리 설정
- 공통 시세 관리 건수 조회(`selectComMvDrveDstncPtclCnt`)
- 건수가 존재할 경우
  - 공통 시세 관리 업데이트(`updateComMvDrveDstncPtclCnt`)
- 건수가 존재하지 않을 경우
  - 공통 시세 주행거리 내역 업데이트(`insertComMvDrveDstncPtcl`)
- 중고차 시세 상한/하한가율 조회(`selectSlcoBvrOPrcItrgCd`)
- 공통 시세 관리 시세 업데이트 (`updateMbPrc`)

<br>

#### getIsptDrveDsrncApclMvPrc()

> 점검주행거리 적용 시세

- 공통 시스템 변수 조회(`selectSysVrbsMgntBaseList`)
- 주행거리 계산 월수 추출
- 주행거리 계산 적용율 추출
- 1달 평균 주행거리 추출
- 1년 평균 주행거리 추출
- 최대 주행거리 추출
- 주행거리 적용율 추출
- 1달 이내 주행거리 일자 계산
- 주행거리확인일로부터 주행거리 계산

<br>

#### getDrveCnfmDt()

> 주행거리 확인일자 조회

- 주행거리 정보 조회
- 주행거리 정보가 존재할 경우
  - 주행거리 확인일자 추출
- 주행거리 정보가 존재하지 않을 경우
  - 갑부사항에서 주행거리 정보 조회

<br>

#### getOtExpryDt()

> 소유권이전 등록 만료일자 조회

- 이전등록 기한 만료일 계산 ➡️ 해지일자 기준 15일 후
- 만료일이 휴일인지 확인(`selectBussDayInfo`)
- 이전등록 기한 만료일 `return`

<br>

#### insertVcexSvcMgntHist()

> 대행서비스 이력 입력

- 응답코드 및 응답데이터, 메시지 등 추출
- 대행서비스 이력 테이블 입력(`insertVcexSvcMgntHist`)

<br>

#### getJbfVhclNo()

> 직전차량번호 조회(보험사고이력 조회 시 사용)

- 갑부상세 내역 조회(`selectMnptDtlsList`)
- 갑부상세 내역만큼 `for문` 통해 정보 추출
- 직전 차량 번호 `return`

<br>

#### getRsnbDrveDstnc()

> 적정 주행거리(주행거리 DB, 표준주행거리) 조회

- 공통 시스템 변수 조회(`selectSysVrbsMgntBaseList`)
- 주행거리 계산 월 수
- 주행거리 계산 적용율
- 1달 평균 주행거리
- 1년 평균 주행거리
- 최대 주행거리
- 1달 이내일 때 일자로 주행거리 재계산

<br>

#### estTaxStdAmt()

> 과세표준금액 산정

- 시가표준액 조회(`getStdMktPrc`)
- 시가표준액이 없을 경우 조회 실패 후 `return`
- 시가표준액이 있을 경우
- 시가표준액 조회 결과 설정
- 비용(감가율) 계산 시 영업용 여부 조건 추가
- 이전비용계산을 위한 과세표준금액 조회(`selectTaxStdAmt`)

<br>

#### getStdMktPrc()

> 소유권 이전 비용 계산을 위한 시가표준액 조회

- 이전 비용 계산용 시가표준액 조회(`selectStdMktPrc`)
- 시가표준액 조회 성공 시
  - 1건 매칭되었을 경우 가장 첫번째 것만 저장
  - 복수개 매칭되었을 경우
    - 검색 조건에 차명 추가(`selectStdMktPrc`)
    - 매칭건 1개 이상일 경우 첫번째 것만 저장
    - 매칭건이 없을 경우(`selectStdMktPrc`)

<br>

#### estAcqsTax()

> 소유권 이전 취득세 산정

- 취득세율 및 감면정보 조회(`selectAcqsTaxInfo`)
- 취득세율, 기본감면금액, 친환경 감면 금액 추출 후 저장
- 친환경 차량일 경우 기본/친환경 감면액 중 높은 금액으로 산정
- 일반차량일 경우 기본 감면액 산정
- 감면액 적용 후 취득세 최종금액을 산정

<br>

#### getCrpnAdr()

> 거래자(양도/양수인)가 법인인 경우 법인 주소 조회

- 근로복지 공단 법인 주소 확인(`rqstOtsdIntfSvcByGet`)
- 근로복지 공단 조회 결과가 성공일 경우
  - 가져온 정보 중 `totalCount`를 변수에 저장
  - `totalCount`가 존재할 경우 해당 `item`을 변수에 저장
  - `totalCount`가 존재하지 않을 경우 나이스정보 스크래핑으로 본사주소 조회(`callPythonProcess`)

<br>

#### getPsnlCrpnDvCd()

> 거래당사자의 개인/법인 구분

- 소유자명에 주 문자열이 포함되면 법인사업자로 저장
- 파라미터에 사업자번호가 존재할 경우
  - 사업자번호 형식 확인 ➡️ 형식이 맞을 경우 법인
  - 사업자번호 형식이 아닐 경우 ➡️ 오류

<br>

#### cnfmAcmn()

> 거래자 실명 확인

- 회원사 ID 7자리로 padding
- 실명 공백 제거
- 실명 40자리로 padding
- SCI 실명 확인 호출(`socket`)
- 실명 확인 호출 결과가 존재할 경우
  - 응답전문코드가 일치할 경우
    - 응답코드가 정상일 경우
      - 업무구분코드가 일치할 경우
      - 실명확인 결과가 일치할 경우 ➡️ 각 정보 변수에 저장
      - 실명확인 결과 불일치할 경우
        - 실명확인 결과에 따라 메시지 저장

<br>

#### 