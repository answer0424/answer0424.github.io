---
layout: post
title: Bean Scopes
date: 2025-09-16 09:00 +09:00
categories: [Spring, IoC Container(dependency)]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## 개요

- Spring에서 Bean Definition은 객체 인스턴스를 만드는 설계도
- 빈 스코프(scope)는 이 설계도로부터 실제 빈 인스턴스들이 얼마나 오래, 어떤 범위에서 유지될지 정의
- Spring은 기본적으로 여러 스코프를 제공, 웹 어플리케이션 맥락(web-aware ApplicationContext)을 쓸 경우에만 유효한 스코프로 있고, 커스텀 스코프도 만들 수 있음

<br>

## 주요 빈 스코프들

| 스코프 이름     | 설명                                                                                      | 사용 예시                                          |
| --------------- | ----------------------------------------------------------------------------------------- | -------------------------------------------------- |
| **singleton**   | 기본값. IoC 컨테이너당 하나의 인스턴스만 생성. 모든 요청에서 동일한 인스턴스 반환         | 상태가 없는(stateless) 서비스 레이어 빈, DAO 빈 등 |
| **prototype**   | 빈 요청 시마다 새로운 인스턴스 생성. IoC 컨테이너가 관리하지 않음(생성 후 소멸 책임 없음) | 상태를 가지는(stateful) 객체, 임시 객체 등         |
| **request**     | 웹 어플리케이션에서 HTTP 요청당 하나의 인스턴스 생성. 요청이 끝나면 소멸                  | 웹 컨트롤러에서 요청별 상태 유지                   |
| **session**     | HTTP 세션당 하나의 인스턴스 생성. 세션이 끝나면 소멸                                      | 사용자 세션별 상태 유지                            |
| **application** | 서블릿 컨텍스트당 하나의 인스턴스 생성. 웹 애플리케이션 전체에서 공유                     | 애플리케이션 범위의 설정 정보 등                   |
| **websocket**   | 웹소켓 세션당 하나의 인스턴스 생성. 웹소켓 세션이 끝나면 소멸                             | 웹소켓 연결별 상태 유지                            |

<br>

## 스코프별 생명주기 및 객체 관리

- **싱글톤**: 애플리케이션 시작 시점에 생성, 애플리케이션 종료 시점에 소멸
- **프로토타입**: 요청 시점에 생성, 이후 컨테이너가 관리하지 않음. 개발자가 직접 소멸 처리 필요

<br>

## 스코프 간의 관계 & 주의사항

- 싱글톤 빈이 프로토타입 빈을 의존할 때 주의 필요: 싱글톤 빈이 생성될 때 프로토타입 빈이 한 번만 주입되므로, 매번 새로운 인스턴스를 원한다면 `@Lookup` 어노테이션이나 메서드 인젝션(method injection) 사용 고려
- 짧은 수명의 스코프를 더 긴 수명의 빈에 의존성으로 주입할 경우 프록시를 사용해야 제대로 동작

<br>

## 웹 스코프 설정 시 초기 구성(WebApplicationContext 관련)

1. **WebApplicationContext** 설정
   - `@Configuration` 클래스에서 `@EnableWebMvc` 어노테이션 추가
   - `DispatcherServlet` 설정 시 `WebApplicationContext` 사용

2. **빈 정의 시 웹 스코프 지정**
   - `@Scope` 어노테이션을 사용하여 빈의 스코프를 웹 스코프로 설정
   - 예: `@Scope(value = WebApplicationContext.SCOPE_REQUEST)`

3. **웹 스코프 빈 사용**
   - 웹 컨트롤러에서 요청 스코프 빈 주입
   - 요청마다 새로운 인스턴스가 생성되어 사용됨
    ```java
   @RestController
   public class MyController {
       @Autowired
       private MyRequestScopedBean myRequestScopedBean;
   }
   ```

<br>

## 커스텀 스코프 만들기
- `org.springframework.beans.factory.config.Scope` 인터페이스 구현
  - `get()`, `remove()`, `registerDestructionCallback()` 등의 메서드 구현
- `ConfigurableBeanFactory`의 `registerScope()` 메서드로 등록
- 스코프 등록 방법:
  - 프로그래밍 방식으로 `ConfigurableBeanFactory.registerScope` 호출
  - XML 설정 시 `CustomeScopeConfigurer` 빈을 이용해서 `<map>` 형태로 스코프 이름과 구현체를 설정

<br>

## 요약

1. 스코프를 선택할 때
  - 상태(state)가 없고 재사용가능하면 singleton
  - 상태가 있고 요청마다 새로 필요하면 prototype 또는 웹 스코프(request/session 등)
2. 의존성 주입 시 스코프 주의
  - 긴 수명 빈(singleton) 안에 짧은 수명 빈(request/session 등)
3. 리소스 정리
  - prototype 빈은 Spring 컨테이너에서 관리하는 라이프사이클의 파괴 롤백 부분이 자동으로 되지 않으므로, 필요하다면 클라이언트에서 명시적으로 정리 필요
4. 웹 환경 설정
  - 웹 스코프를 사용하려면 request/response, 세션 등이 적절히 바인딩되어야 함
5. 커스텀 스코프
  - 애플리케이션에 특수한 라이프사이클 요구사항이 있으면 커스텀 스코프 사용 가능