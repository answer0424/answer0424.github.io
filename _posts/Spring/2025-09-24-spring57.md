---
layout: post
title: JPA
date: 2025-09-23 09:00:00 +09:00
categories: [Spring, DataAccess, Transaction Management, ORM]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## Spring 환경에서의 JPA 설정 방식

- `LocalEntityManagerFactoryBean`: 단순 실행이나 테스트 용도, `persistence.xml` 기반, 글로벌 트랜잭션 미지원
- `JNDI` 기반 설정: Jakarta EE 서버에서 제공하는 `EntityManagerFactory`를 JNDI로 획득
- `LocalContainerEntityManagerFactoryBean`: 가장 유연한 방식, DataSource, 벤더 어댑터, 로드타임 위빙, 다중 persistence unit 관리 가능
- 로드 타임 위버(Load-Time Weaving/LTW): JPA 제공자가 필요할 때 클래스 로더 수준에서 위빙 적용
- 다중 Persistence Unit: `PersistenceUnitManager`, `DefaultPersistenceUnitManager`, `PersistenceUnitPostProcessor`로 제어
- 비동기 부트스트래핑: `bootstrapExecutor`로 EntityManagerFactory 초기화를 백그라운드에서 실행

> 일반적인 `persistence.xml` 예시

```xml
<persistence xmlns="http://java.sun.com/xml/ns/persistence" version="1.0">
    <persistence-unit name="myUnit" transaction-type="RESOURCE_LOCAL">
        <mapping-file>META-INF/orm.xml</mapping-file>
        <exclude-unlisted-classes/>
    </persistence-unit>
</persistence>
```

<br>

## DAO 구현

- `EntityManagerFactory`는 스레드 안전, `EntityManager` 스레드는 안전하지 않음
- Spring은 트랜잭션 범위 내 공유 `EntityManager` 프록시 제공
- @PersistenceUnit ➡️ `EntityManagerFactory` 주입
- @PersistenceContext ➡️ 트랜잭션 범위 `EntityManager` 주입
  - `type=TRANSACTION` (기본)
  - `type=EXTENDED` (상태 유지, 스레드 안전하지 않음)
- Spring과 완전히 분리된 DAO도 가능 (`@PersistenceUnit`/`@PersistenceContext` 처리 가능)
- `@Autowired`로도 주입 가능. 다만 공유 `EntityManager` 주입 시 `SharedEntityManagerBean` 정의 필요

<br>

## Spring 주도 JPA 트랜잭션

- 권장: JpaTransactionManager 기반 로컬 트랜잭션
- JDBC DAO와도 통합 가능
- **JpaDialect**: 벤더별 특화 기능 제공
- **JpaVendorAdapter**: 벤더 기본 설정 + JpaDialect 제공

<br>

## JTA 트랜잭션 관리

- 멀티 리소스 트랜잭션 시 `JtaTransactionManager` 사용
- XA 지원 DataSource 필요
- Hibernate 등 구현체 사용 시 추가 속성 설정 필요(`hibernate.connection.handling_mode` 등)
- 보통 JNDI를 통해 `EntityManagerFactory`를 받아오는 게 자연스러움

<br>

## Hibernate 네이티브와 JPA 상호작용

- Hibernate의 `SessionFactory`는 JPA의 `EntityManagerFactory`를 구현
- Spring은 `@PersistenceContext`와 Hibernate Session간 상호작용 가능
- `HibernateTransactionManager` 사용 시 Hibernate 네이티브 기능을 더 적극 활용 가능
- 네이티브 설정도 백그라운드 부트스트래핑 지원