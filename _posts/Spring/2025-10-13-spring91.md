---
layout: post
title: Exception
date: 2025-10-13 13:00:00 +09:00
categories: [Spring, Servlet Stack, Web MVC, Annotated Controller]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## 개요 및 역할

- `@ExceptionHandler`는 `@Controller` 또는 `@ControllerAdvice` 클래스 내에서 선언할 수 있는 메서드 수준 어노테이션으로 해당 컨트롤러에서 발생한 예외를 잡아 처리할 수 있게 해줌
- 이 기능은 Spring MVC의 `HandlerExceptionResolver` 체계 위에서 동작하며, 컨트롤러 메서드에서 던져진 예외가 있을 경우 `DispatcherServlet` ➡️ `HandlerExceptionResolver` 흐름과 연동되어 해당 예외 처리 메서드가 호출
- 기본적으로 `@ExceptionHandler` 메서드는 예외 타입과 매핑되어, 여러 예외 타입을 배열 형태로 지정할 수도 있음

<br>

## 예시 코드

```java
@Controller
public class SimpleController {
    @ExceptionHandler(IOException.class)
    public ResponseEntity<String> handle() {
        return ResponseEntity.internalServerError().body("I/O Error");
    }
}
```

- 컨트롤러 내에서 `IOException`이 발생하면, `handle()` 메서드가 호출
- `ResponseEntity<String>`을 반환하여 HTTP 응답 본문과 상태 코드를 함께 제어

<br>

```java
@ExceptionHandler({FileSystemException.class, RemoteException.class})
public ResponseEntity<String> handleIoException(IOException ex) {
    return ResponseEntity.internalServerError().body(ex.getMessage());
}
```

```java
@ExceptionHandler({FileSystemException.class, RemoteException.class})
public ResponseEntity<String> handleExceptions(Exception ex) {
    return ResponseEntity.internalServerError().body(ex.getMessage());
}
```

<br>

## 예외 매핑 규칙 및 우선순위

- `@ExceptionHandler`는 발생한 예외 타입뿐만 아니라 그 예외가 감싸인 예외의 원인까지 탐색하여 매칭할 수 있음
- 즉, 예외가 직접 `IOException`이 아니더라도 `IOException`을 감싸는 예외 구조에 있다면 매칭 가능성이 있음
- Spring 5.3부터는 예외 타입 매칭 시 원인 수준을 기준으로 비교할 수 있게 되어, 더 유연한 매칭이 가능
- 여러 `@ExceptionHandler` 메서드가 매핑 가능한 경우, 더 깊이 가까운 예외 매칭이 우선됨
- 만약 `@ExceptionHandler` 메서드가 특정 예외 인스턴스 처리를 포기하고자 한다면, 내부에서 예외를 다시 throw할 수 있으며, 그러면 해당 예외는 다음 처리 체인으로 전달
- 또한 여러 `@ControllerAdvice`가 있을 경우 우선 순위를 지정할 수 있으며, 우선순위가 노ㅠ은 `@ControllerAdvice`의 `@ExceptionHandler`가 먼저 고려될 수 있음

<br>

## 미디어 타입 매핑(Content Negotiation)

- `@ExceptionHandler` 메서드는 `produces` 속성을 사용해 처리할 미디어 타입을 지정할 수 있음

```java
@ExceptionHandler(produces = "application/json")
public ResponseEntity<ErrorMessage> handleJson(IllegalArgumentException exc) {
    return ResponseEntity.badRequest().body(new ErrorMessage(exc.getMeesage(), 42));
}

@ExceptionHandler(produces = "text/html")
public String handleHtml(IllegalArgumentException exc, Model model) {
    model.addAttribute("error", new ErrorMessage(exc.getMessage(), 42));
    return "errorView";
}
```

<br>

## 메서드 인자 및 반환 타입 지원

#### 메서드 인자

| 인자 타입 | 설명 |
|---|---|
| 예외 타입 | 해당 예외 객체를 내부에서 사용할 수 있음 |
| `HandlerMethod` | 예외가 발생한 컨트롤러 메서드 정보에 접근 가능 |
| `WebRequest`/`NativeWebRequest` | 요청 파라미터, 세션, 속성 등에 접근 가능 |
| `ServletRequest`/`ServletResponse`/`HttpServletRequest`/`HttpServletResponse` | 서블릿 API 객체에 직접 접근 가능 |
| `HttpSession` | 세션 객체를 인자로 받을 수 있음 |
| `Principal` | 현재 인증된 사용자 정보 접근 가능 |
| `HttpMethod` | 요청의 HTTP 메서드 정보 |
| `Locale`/`TimeZone`/`ZoneId` | 요청의 지역, 시간대 정보 접근 가능 |
| `OutputStream`/`Writer` | 직접 응답 바디 스트림에 쓰는 경우 사용 가능 |
| `Map`, `Model`, `ModelMap` | 모델 속성 추가 가능 |
| `RedirectAttributes` | 리다이렉트 시 사용할 속성 지정 가능 |
| `@SessionAttribute`, `@RequestAttribute` | 세션/요청 속성 접근 가능 |

<br>

#### 반환 타입

| 반환 타입 | 역할/동작 |
|---|---|
| `@ResponseBody` 어노테이션이 붙은 타입 | 응답 본문 방식으로 변환되어 응답됨 |
| `HttpEntity<B>`/`ResponseEntity<B>` | 응답 본문 + 헤더 + 상태 등을 제어할 수 있음 |
| `ErrorResponse`, `ProblemDetail` | Spring에서 RFC 9457 기반 오류 응답으로 직렬화 가능 |
| `String` | 뷰 이름으로 해석되어 View Resolver가 렌더링하는 방식 |
| `View` | 직접 `View` 객체를 반환하여 렌더링 제어 가능 ||
| `@ModelAttribute` | 메서드 반환 객체가 모델 속성으로 추가되고 뷰 이름이 암묵적으로 결정됨 |
| `ModelAndView` | 뷰 + 모델 + 상태 등을 함께 반환 가능 |
| `void` | `void` 또는 `null` 반환 시 특정 조건 하에 응답 처리 완료로 간주되거나 기본 뷰 이름을 사용함. 단, `ServletResponse` 혹은 `OutputStream` 인자가 있거나 `@ResponseStatus`가 붙어 있어야 완전 처리로 간주 |