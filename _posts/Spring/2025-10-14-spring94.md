---
layout: post
title: URI Links
date: 2025-10-14 09:00:00 +09:00
categories: [Spring, Servlet Stack, Web MVC]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## `UriComponentsBuilder` / `UriComponents`

#### 역할 및 기본 사용

- `UriComponentsBuilder`는 URI 템플릿 + 쿼리 파라미터 등을 조합하여 URI를 동적으로 생성할 수 있게 해주는 헬퍼 클래스
- `UriComponents`는 빌드된 URI의 구성요소를 감고 있으며, 변수 확장과 인코딩 기능을 제공

<br>

#### 예제 1: 단계별 URI 빌딩

```java
UriComponents uriComponents = UriComponentsBuilder
    .fromUriString("http://example.com/hotels/{hotel}")
    .queryParam("q", "{q}")
    .encode()
    .build();

URI uri = uriComponents.expand("Westin", "123").toUri();
```

- `fromUriString()`에서 기본 템플릿 URI를 지정
- `queryParam("q", "{q}")`로 쿼리 파라미터 템플릿 추가
- `.encode()`를 통해 URI 템플릿 및 변수에 대한 인코딩 요청
- `.build()`를 통해 `UriComponents` 객체 생성
- `.expand(...)`을 통해 구체적인 변수 값을 적용
- `.toUri()`로 `java.net.URI` 객체 획득

<br>

#### 예제 2: `buildAndExpand` / `build(...)` 단축 방식

```java
URI uri = UriComponentsBuilder
        .fromUriString("https://example.com/hotels/{hotel}")
        .queryParam("q", "{q}")
        .encode()
        .buildAndExpand("Westin", "123")
        .toUri();
```

```java
URI uri = UriComponentsBuilder
        .fromUriString("https://example.com/hotels/{hotel}?q={q}")
        .build("Westin", "123");
```

<br>

## `UriBuilder` / `UriBuilderFactory` / `DefaultUriBuilderFactory`

#### 개념 및 활용

- `UriComponentsBuilder`는 `UriBuilder`의 구현체이며, `UriBuilderFactory`는 URI 빌더 생성 전략을 추가상화한 팩토리
- `DefaultUriBuilderFactory`는 기본 구현체로 공통 설정을 보유할 수 있으며 `UriComponentsBuilder`를 내부적으로 사용
- `RestTemplate`이나 `WebClient`에서 이 `UriBuilderFactory`를 설정하여 URI 빌딩 전략을 커스터마이징할 수 있음

```java
String base = "https://example.org";
DefaultUriBuilderFactory factory = new DefatultUriBuilderFactory(base);
factory.setEncodingMode(DefaultUriBuilderFactory.EncodingMode.TAMPLATE_AND_VALUES);

RestTemplate rt = new RestTemplate();
rt.setUriTemplateHandler(factory);

WebClient wc = WebClient.builder()
    .uriBuilderFactory(factory)
    .build();
```

- 인코딩 모드 옵션
  - `TEMPLATE_AND_VALUES`
  - `VALUES_ONLY`
  - `URI_COMPONENT`
  - `NONE`
- 기본값은 `RestTemplate`의 경우 `EncodingMode.URI_COMPONENT`이며, `WebClient`는 기본값을 `TEMPLATE_AND_VALUES`로 변경한 바가 있음

<br>

## 상대 URI 빌드: `ServletUriComponentsBuilder`

#### 예제: 요청 기반 URI 생성

```java
HttpServletRequest request = ...;

URI uri = ServletUriComponentsBuilder.fromRequestUri(request)
    .replacePath("accountId", "{id}")
    .build("123")
```

- 이 방식은 현재 요청의 scheme, host, port, path, 쿼리 문자열 등을 재활용함
- 또한 `fromContextPath(request)`를 사용하면 context path까지만 사용하고 나머지는 덧붙이는 경로를 설정 가능

```java
URI uri = ServletUriComponentsBuilder
    .fromContextPath(request)
    .path("/accounts")
    .build()
    .toUri();
```

- 또는 `fromServletMapping(request)`를 사용하면 서블릿 매핑 기준 위에서 경로를 덧붙이는 방식도 지원

<br>

## 컨트롤러 메서드에 대한 링크 생성: `MvcUriComponentsBuilder`

#### 기본 방식: `fromMethodName`

```java
UriComponents uriComponents = MvcUriComponentsBuilder
    .fromMethodName(BookingController.class, "getBooking", 21)
    .buildAndExpand(42);

URI uri = uriComponents.encode().toUri();
```

- 첫 번째 인자로 컨트롤러 클래스, 두 번째 인자로 메서드 이름, 그 이후 인자는 메서드의 파라미터
- `buildAndExpand(...)`으로 변수 값을 채우고 `.encode()`와 `.toUri()`를 통해 최종 `URI` 획득


<br>

#### 또 다른 방식: `fromMethodCall(on(...))`

- 메서드 이름 문자열 대신, 메서드 호출을 흉내내는 방식을 사용하여 링크를 생성할 수 있음

```java
UriComponents uriComponents = MvcUriComponentsBuilder
    .fromMethodCall(on(BookingController.class).getBooking(21))
    .buildAndExpand(42);

URI uri = uriComponents.encode().toUri();
```

- 이 방식은 더 타입 안전하고 리팩토링 시점에 안정성을 제공하지만, 반환 타입 제한이 있음

<br>

#### 베이스 URL 또는 상대 기준으로 링크 생성

- 기본 `MvcUriComponentsBuilder`는 현재 요청의 scheme, host, port, servlet path 등을 사용해 베이스 URI를 결정함

```java
UriComponentsBuilder base = ServletUriComponentsBuilder
    .fromCurrentContextPath()
    .path("/en");

MvcUriComponentsBuilder builder = MvcUriComponentsBuilder.relativeTo(base);

builder.withMethodCall(on(BookingController.class).getBooking(21))
    .buildAndExpand(42)
    .encode()
    .toUri();
```

- 이 방식은 국제화, 프록시 서버 뒤의 경로 등 복잡한 URL 구조를 구성할 때 유용
- 또한, `Forward`/`X-Forwarded-*` 헤더 처리를 위해 `ForwardedHeaderFilter`를 사용하는 걸 문서에서 권장

<br>

## 인코딩 고려사항

- `UriComponentsBuilder#encode()`: 템플릿 + 변수 모두에 대해 인코딩을 미리 수행
- `UriComponents#encode()`: 변수 확장 후에 인코딩 수행
- 둘은 같은 입력이라도 인코딩 순서 차이로 다른 결과가 나올 수 있음
- 보통 `encode()`를 호출한 후 `buildAndExpand(...)`를 사용하는 방식이 권장

<br>

## 요약 및 활용 팁

- `UriComponentsBuilder` / `UriComponents`로 템플릿 기반 URI를 동적으로 만들고 변수로 확장할 수 있음
- `ServletUricomponentsBuilder`를 활용하면 현재 요청 정보 기반으로 상대 URI를 빌드 할 수 있음
- `MvcUriComponentsBuilder`를 통해 컨트롤러 메서드 기반 링크를 생성할 수 있으며, 뷰-컨트롤러 간 결합도를 낮출 수 있음
- 인코딩 전략을 잘 선택하고 `Forwarded`헤더 고려가 필요한 경우 `ForwardedHeaderFilter` 등을 활용해야 함
- 뷰 내에서도 Spring 태그 라이브러리 등을 통해 컨트롤러 기반 URL 참조가 가능