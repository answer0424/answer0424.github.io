---
layout: post
title: HTML Fragments
date: 2025-10-16 09:00:00 +09:00
categories: [Spring, Servlet Stack, Web MVC, View Technologies]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## 개념 및 목적

- 전통적인 MVC 방식에서 컨트롤러는 하나의 뷰와 모델을 반환
- 그러나 현대 웹 어플리케이션에서는 클라이언트가 페이지 내 여러 영역을 업데이트해야 할 경우가 많음 이럴 때 전체 페이지가 아닌 여러 개의 HTML fragment를 반환하는 방식이 유용
- Spring MVC는 이러한 HTML-over-the-wire 접근 방식을 지원하기 위해 컨트롤러 메서드가 여러 조각을 반환할 수 있도록 `Collection<ModelAndView>` 또는 전용 타입 `FragmentsRendering`을 지원
- 또한 HTMX 또는 Hotwire Turbo 같은 프레임워크와 함께 사용될 때 서버로부터 부분적인 HTML 업데이트를 스트리밍 방식으로 클라이언트에 전송할 수 있음

<br>

## 반환 방식

#### 1. `Collection<ModelAndView>`

```java
@GetMapping("/some")
public List<ModelAndView> handle() {
    return List.of(
        new ModelAndView("posts"),
        new ModelAndView("comments")
    );
}
```

- 위 코드처럼 여러 `ModelAndView` 객체를 리스트 형태로 반환할 수 있음
- 각 fragment마다 별도의 뷰가 지정될 수 있고, 각 fragment에 독립적인 모델 데이터를 적용할 수 있음
- 요청 수준의 공유 모델은 각 fragment의 개별 모델이 상속받음

<br>

#### 2. `FragmentsRendering`

```java
@GetMapping("/some")
public FragmentsRendering handle() {
    return FragmentsRendering
        .with("posts")
        .fragment("comments")
        .build();
}
```

- `with("posts")`와 `fragment("comments")` 등을 체인 형식으로 지정하여 여러 fragment 뷰를 조합할 수 있음
- 내부적으로 `FragmentsRendering`은 여러 fragment에 대한 뷰와 모델 매핑을 캡슐화함
- 이 방식은 `Collection<ModelAndView>` 방식보다 더 가독성이 있고, fragment 구성을 선언적으로 표현할 수 있다는 장점이 있음

<br>

## 스트리밍 방식 & SSE 연계

- HTMX, Turbo 등 프론트엔트 프레임워크와 함께 SSE(Server-Sent Events) 기반으로 fragment 응답을 스트리밍할 수도 있음
- 컨트롤러 메서드는 `SseEmitter`를 반환하고  내부에서 여러번 `send(...)` 호출을 통해 `ModelAndView` 객체를 순차적으로 전송할 수 있음\

```java
@GetMapping("streamFragments")
public SseEmitter streamFragments() {
    SseEmitter emitter = new SseEmitter();
    startWorkerThread(() -> {
        try {
            emitter.send(SseEmitter.event().data(new ModelAndView("posts")));
            emitter.send(SseEmitter.event().data(new ModelAndView("comments")));

            emitter.complete();
        } catch (IOException ex) {
            emitter.completeWithError(ex);
        }
    });
    return emitter;
}
```

- 또한 `Flux<ModelAndView>`나 반응형 `Publisher<ModelAndView>` 타입으로 반환하는 것도 가능
- 이 경우 `ReactiveAdapterRegistry`를 통해 적절한 어댑터가 적용되어 fragment 스트리밍이 이루어짐

<br>

## 요약 및 활용 시 고려사항

| 항목 | 요약 |
|-|-|
| 목적 | 클라이언트가 여러 영역을 업데이트할 때, 전체 페이지가 아닌 여러 HTML fragment를 반환 |
| 반환 방식 | ` Collection<ModelAndView>`, `FragmentsRendering` |
| SSE 스트리밍 | `SseEmitter` 또는 `Flux<ModelAndView>`로 fragment를 스트리밍 가능 |
| 모델 상속 | 개별 fragment 모델은 요청 공유 모델의 속성을 상속받음 |
| 프론트엔드 연계 | HTMX, Turbolinks, Turbo 등이 fragment 응답을 클라이언트 쪽에서 처리할 수 있게 구성 가능 |