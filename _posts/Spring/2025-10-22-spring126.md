---
layout: post
title: SockJS Fallback
date: 2025-10-22 09:00:00 +09:00
categories: [Spring, Servlet Stack, Web MVC, WebSockets]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## 개요

- WebSocket은 양방향 통신에 매우 유용하지만, 네트워크 프록시 제한, 브라우저 미지원, Upgrade 헤더 차단 등의 이유로 정상 연결되지 않을 수 있음
- SockJS는 이러한 경우를 대비해 어플리케이션 코드를 변경하지 않고도 WebSocket API를 흉내 내어 다른 전송 방식을 사용하는 폴백 메커니즘을 제공
- 즉, 기본적으로 WebSocket을 시도하고, 실패하거나 제한이 있을 경우 HTTP 스트리밍 또는 롱폴링 등의 대체 수단으로 자동 전환됨

<br>

## 적용 및 설정 방법

```java
@Configuration
@EnableWebSocket
public class WebSocketConfig implements WebSocketConfigurer {
    @Override
    public void registerWebSocketHandlers(WebSocketHandlerRegistry registry) {
        registry.addHandler(myHandler(), "/myHandler")
                .withSockJS(); // SockJS 활성화
    }

    @Bean
    public WebSocketHandler myHandler() {
        return new MyHandler();
    }
}
```

- 위 설정에서 `.withSockJS()` 호출이 폴백 기능을 활성화하는 핵심

```xml
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:websocket="http://www.springframework.org/schema/websocket"
       xsi:schemaLocation="
         http://www.springframework.org/schema/beans
         https://www.springframework.org/schema/beans/spring-beans.xsd
         http://www.springframework.org/schema/websocket
         https://www.springframework.org/schema/websocket/spring-websocket.xsd">

    <websocket:handlers>
        <websocket:mapping path="/myHandler" handler="myHandler"/>
        <websocket:sockjs/>
    </websocket:handlers>

    <bean id="myHandler" class="com.example.MyHandler"/>
</beans>
```

- 폴백을 위한 SockJS 지원이 `<websocket:sockjs/>` 요소로 활성화됨

<br>

## 작동 방식 요약

- 클라이언트는 먼저 `GET /info` 요청을 서버에 보내며, 서버가 지원 가능한 전송 방식을 알려줌
- 서버 및 클라이언트는 가능한 경우 우선적으로 WebSocket 전송을 사용
- WebSocket이 불가능한 경우 다음과 같은 전송 방식으로 순차적으로 시도
  - HTTP 스트리밍
  - HTTP 롱폴링
- 메시지 프레임 환산 방식: 예컨데 서버는 `o`(open), `a[...]`(array of messages), `h`(heartbeat), `c[...]`(close) 등의 프레임을 사용

<br>

## 유의사항 및 팁

- 오래된 브라우저나 제약이 많은 프록시 환경에서는 폴백이 자주 필요할 수 있으며, 이 경우 쿠키 사용, iframe 기반 전송 등의 이슈가 있음
- `sessionCookieNeeded` 옵션 등이 있으며, 기본적으로 `JSESSIONID` 등의 세션 쿠키가 필요한 경우에는 해당 옵션이 켜져 있음
- CORS 및 리버스 프록시 설정이 폴백 전송 방식에 영향을 줄 수 있으므로, WebSocket 외 전송 방식까지 고려하여 설정해야 함
- 실제로 대부분의 최신 브라우저 및 환경에서는 WebSocket이 지원되므로, 폴백 기능을 활성화했다고 항상 사용되는 것은 아님