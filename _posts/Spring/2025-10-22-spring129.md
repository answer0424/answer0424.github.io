---
layout: post
title: Enable STOMP
date: 2025-10-22 09:00:00 +09:00
categories: [Spring, Servlet Stack, Web MVC, WebSockets, STOMP]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## 활성화 절차 및 설정

#### 의존성 준비

- STOMP over WebSocket 기능을 사용하기 위해서는 `spring-websocket` 및 `spring-messaging` 모듈이 클래스 패스에 있어야 함

<br>


#### 구성 어노테이션 및 설정 클래스

- Java 설정 기준으로는, 설정 클래스에 `@Configuration`과 `@EnableWebSocketMessageBroker` 어노테이션이 붙어야 함
- 이 클래스는 `WebSocketMessageBrokerConfigurer` 인터페이스를 구현하여 다양한 STOMP-엔드포인트와 메시지 브로커 설정을 오버라이드 할 수 있음

<br>

#### STOMP 엔드포인트 등록

- `registerStompEndpoints(StompEndpointRegistry registry)` 메서드에서 클라이언트가 WebSocket으로 연결할 URL을 등록함

```java
registry.addEndpoint("/portfolio");
```

- 위 예시는 `/portfolio`라는 HTTP URL이 클라이언트가 WebSocket 핸드셰이크를 요청하는 엔드포인트임을 나타냄
- 최소한 기본 WebSocket 엔드포인트를 등록하며, 필요시 `withSockJS()` 옵션을 붙여 폴백 지원도 설정할 수 있음

<br>

#### 메시지 브로커 및 목적지 설정

- `configureMessageBroker(MessageBrokerRegistry config)` 메서드에서 다음과 같은 설정이 이루어짐
  - `config.setApplicationDestinationPrefixes("/app");` 처럼 클라이언트가 메시지를 보낼 때 사용할 “애플리케이션 목적지 접두사(application destination prefix)”를 설정할 수 있습니다. 이 접두사로 시작하는 목적지는 컨트롤러(@MessageMapping) 메서드로 라우팅됨
  - `config.enableSimpleBroker("/topic", "/queue");` 처럼 내장 메시지 브로커(simple broker)를 활성화하고, 구독(subscription) 또는 브로드캐스트(broadcast)용 목적지 접두사를 지정할 수 있음

<br>

#### XML 설정 방식

```xml
<beans …>
  <websocket:message-broker application-destination-prefix="/app">
    <websocket:stomp-endpoint path="/portfolio" />
    <websocket:simple-broker prefix="/topic, /queue"/>
  </websocket:message-broker>
</beans>
```


<br>

## 작동 흐름 간단 요약

1. 클라이언트가 `/portfolio` 엔드포인트에 WebSocket 핸드셰이크 요청을 보냄
2. 연결이 성공하면 STOMP 프로토콜이 활성화됨
3. 클라이언트가 `/app/...` 접두사의 목적지로 메시지를 보낼 경우, `@MessageMapping`이 붙은 컨트롤러 메서드로 전달됨
4. 서버는 응답을 `/topic/...` 또는 `/queue/...`  접두사의 목적지로 발생
5. 구독한 클라이언트들이 해당 메시지를 수신