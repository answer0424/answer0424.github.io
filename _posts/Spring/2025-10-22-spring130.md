---
layout: post
title: WebSocket Transport
date: 2025-10-22 09:00:00 +09:00
categories: [Spring, Servlet Stack, Web MVC, WebSockets, STOMP]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---


## 개요

- STOMP 위에서 WebSocket 통신을 구현할 경우, 서버 측에서는 WebSocket 엔드포인트 등록, 메시지 브로커 설정, 핸들러 지정, 전송 규격 설정 등의 서버 구성이 필요
- 특히 서버 측에서 STOMP 메커니즘을 활성화하고, 메시지 브로커와 목적지 세션 관리, 메시지 전송 규격 등을 설정하는 방법을 설명
- 즉, 클라이언트가 STOMP 프레임을 통해 메시지를 보내고 구독하는 구조를 서비스로 제공하고자 할 때, 서버에서 해야 할 설정들이 여기에 포함

<br>

## 서버 구성 주요 단계 및 설정 포인트

#### 1. STOMP 엔드포인트 등록

- `@Configuration` 클래스에 `@EnableWebSocketMessageBroker` 어노테이션을 붙이고, `WebSocketMessageBrokerConfigurer` 인터페이스를 구현
- `registerStompEndpoints(StompEndpointRegistry registry)` 메서드에서 클라이언트가 WebSocket으로 연결할 URL을 등록

```java
@Configuration
@EnableWebSocketMessageBroker
public class WebSocketConfig implements WebSocketMessageBrokerConfigurer {
    @Override
    public void registerStompEndpoints(StompEndpointRegistry registry) {
        registry.addEndpoint("/ws-endpoint")
                .setAllowedOrigins("*")
                .withSockJS(); // SockJS 폴백 지원
    }
}
```

- 이 설정을 통해 `/ws-endpoint`로 접속한 클라이언트가 WebSocket 핸드셰이크를 시도할 수 있음

<br>

#### 2. 메시지 브로커 및 목적지 설정

- `configureMessageBroker(MessageBrokerRegistry config)` 메서드에서 서버 측 메시징 흐름을 설정함

```java
@Override
public void configureMessageBroker(MessageBrokerRegistry config) {
    config.setApplicationDestinationPrefixes("/app"); // 클라이언트가 메시지를 보낼 때 사용하는 접두사
    config.enableSimpleBroker("/topic", "/queue"); // 간단한 메모리 기반 브로커 활성화

}
```

- `setApplicationDestinationPrefixes(...)`: 클라이언트가 보낼 메시지의 목적지 접두사를 지정함
  - 이 접두사가 붙은 메시지는 `@MessageMapping` 등이 붙은 메서드로 라우팅됨
- `enableSimpleBroker(...)`: 서버 내부에 단순 브로커를 활성화하여 `/topic`, `/queue` 접두사의 목적지로 발행한 메시지를 구독한 클라이언트에게 전달
- 외부 메시지 브로커와 연동하려면 `enableStompBrokerRelay(...)` 를 사용하여 STOMP 브로커 릴레이 구성 가능

<br>

#### 3. 메시지 전송 및 세션 설정

- 메시지 전송 규격, 세션 관리, 헤더 처리, 사용자 대상 메시지 등의 상세 설정이 가능
  - 사용자별 목적지 접두사: `config.setUserDestinationPrefix("/user");`
  - 헤더 변환, 메시지 크기 제한, heartbeat 등 전송 성능 및 안정성 설정 가능
  - 핸드셰이크 인터셉터 등록: `registry.addEndpoint(...).addInterceptors(...)` 등을 통해 인증 처리 가능