---
layout: post
title: Annotated Controller
date: 2025-10-23 09:00:00 +09:00
categories: [Spring, Servlet Stack, Web MVC, WebSockets, STOMP]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

##  주요 어노테이션 및 사용 방법

#### 1. `@MessageMapping`

- 이 어노테이션을 사용하면 클라이언트가 보내는 STOMP 목적지에 따라 해당 메서드를 호출할 수 있음
- 클래스 레벨에도 붙일 수 있어서, 컨트롤러 전체에 공통된 경로 접두사를 지정할 수 있음
- 기본적으로 값에는 Ant 스타일 경로 패턴이 들어감 (`"/chat/{roomId}"`, `"/topic/**"` 등)

###### 메서드 인자 지원

- `Message<?> message`: 전체 메시지 객체
- `MessageHeaders headers`: 메시지 헤더 맵
- `SimpMessageHeaderAccessor`, `StompHeaderAccessor`: 헤더 정보를 타입 세이프하게 다룰 수 있는 도구
- `@Payload T payload`: 메시지 본문을 변환하여 바인딩 `@Valid` 또는 `@Validated`와 함께 유효성 검사 가능
- `@Header("someHeader") Foo headerValue`: 특정 헤더값 취득
- `@Headers Map<String, Object> allHeaders`: 모든 헤더 맵을 취득 가능
- `@DestinationVariable String var`: 경로 변수로 지정된 템플릿 변수 추출 (예: `/chat/{roomId}`에서 `roomId` 추출)
- `Principal principal`: WebSocket 핸드셰이크 당시 연결된 사용자의 인증 추세

##### 반환값

- `@MessageMapping` 메서드의 반환값은 기본적으로 `MessageConverter`를 통해 직렬화되어 브로커 채널을 통해 발송됨. 목적지는 기본적으로 인바운드에서 `/app` 접두사가 `/topic` 또는 `/queue` 등으로 바뀐 형태가 됨
- `@SendTo` 또는 `@SendToUser` 어노테이션을 사용하여 명시적으로 출력 목적지를 지정할 수 있음
- 비동기 반환 타입도 지원됨 (`ListenableFuture`, `CompletableFuture`, `CompletionStage`)

<br>

#### 2. `@SubscribeMapping`

- 구독 요청만을 처리하기 위한 메서드에 사용됨. 클라이언트가 `SUBSCRIBE` 프레임을 보내면 해당 메서드가 호출됨
- `@MessageMapping`과 거의 동일한 인자 조건을 지원
- 다만 반환값의 기본 동작이 다름: 기본적으로 해당 메서드의 반환값은 브로커로 보내지는 것이 아니라 해당 클라이언트로 직접 전송됨. 구독 응답 초기 데이터 제공용으로 유용
- 만약 `@SendTo` 또는 `@SendToUser`를 지정하면 브로커를 통해 다른 구독자 또는 특정 사용자에게도 메시지를 보낼 수 있음

<br>

#### 3. `@MessageExceptionHandler`

- `@Controller` 내에서 예외 처리 전용 메서드를 정의할 때 사용
- 메서드 인자/반환 타입은 `@MessageMapping` 메서드와 동일한 규격을 따름
- 전역 처리를 위해 `@ControllerAdvice` 클래스 내에 정의할 수도 있음

<br>

## 예제 코드