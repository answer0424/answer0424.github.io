---
layout: post
title: External Broker
date: 2025-10-23 09:00:00 +09:00
categories: [Spring, Servlet Stack, Web MVC, WebSockets, STOMP]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## 개요

- Spring이 제공하는 내장형 단순 브로커 대신, 실제 메시지 브로커를 STOMP 릴레이 방식으로 연결해 메시지 송수신을 처리할 수 있음
- 이 방식에서는 Spring이 브로커와 TCP 연결을 맺고 클라이언트들과 WebSocket/STOMP 통신을 유지하면서 메시지를 브로커에 전달하고 브로커에서 받은 메시지를 다시 WebSocket 클라이언트에게 전달하는 중계 역할을 수행하게 됨
- 따라서 여러 서버에 걸쳐 있는 클라이언트들, 고가용성 환경, 대량 메시지 발송 등 확장성 및 신뢰성이 요구되는 시스템에서 적합한 방식

<br>

## 설정 방식

```java
@Configuration
@EnableWebSocketMessageBroker
public class WebSocketConfig implements WebSocketMessageBrokerConfigurer {

    @Override
    public void registerStompEndpoints(StompEndpointRegistry registry) {
        registry.addEndpoint("/ws-endpoint").withSockJS();
    }

    @Override
    public void configureMessageBroker(MessageBrokerRegistry registry) {
        registry.enableStompBrokerRelay("/topic/", "/queue/")
                // 추가 설정 가능: .setRelayHost("broker.example.com")
                // .setRelayPort(61613).setClientLogin("user").setClientPasscode("pass");
                ;
        registry.setApplicationDestinationPrefixes("/app");
    }
}
```

- 위 설정에서 `enableStompBrokerRelay("/topic", "/queue")`를 통해 외부 브로커 릴레리를 활성화함

```xml
<websocket:message-broker application-destination-prefix="/app">
  <websocket:stomp-endpoint path="/ws-endpoint">
    <websocket:sockjs/>
  </websocket:stomp-endpoint>
  <websocket:stomp-broker-relay prefix="/topic,/queue"
                                relay-host="broker-host"
                                relay-port="61613"
                                client-login="user"
                                client-passcode="pass"/>
</websocket:message-broker>
```


<br>

## 특징 및 고급 설정

- 시스템 연결: Spring은 브로커 릴레이와 서버 사이에 시스템 TCP 연결을 맺고, 서버 어플리케이션이 생성한 메시지를 이 연결을 통해 브로커에 전달
- 클라이언트별 연결: WebSocket 클라이언트 한 명당 브로커와의 별도의 TCP 연결이 만들어질 수 있으며, Spring이 이를 관리
- 자동 재접속 & heartbeat: 브로커 릴레이는 브로커 접속이 끊어졌을 때, 재접속을 시도하며 heartbeat 값을 설정할 수 있음
- 확장성 및 클러스터링 지원: 외부 브로커 릴레이는 여러 서버 인스턴스에서 동이한 브로커를 이용해 메시지를 공유/브로드캐스트할 수 있어, 분산 환경에서 유리
- 헤더 및 가상호스트 설정 가능: 예컨대 클라우드 환경에서 실제 호스트와 사용되는 호스트가 다를 경우 `virtualHost` 속성을 설정해 `host` 헤더를 제어할 수 있음

<br>

## 유의사항 & 고려사항

- 외부 브로커 릴레이를 사용하면 설정 복잡도가 증가하고, 브로커 인프라를 따로 신경써야 함
- 브로커 연결이 끊겼을 때 메시지의 유실 가능성, 지연 증가 가능성이 있으므로 설계 시 주의해야 함
- WebSocket/STOMP 클라이언트가 `login`/`passcode` 헤더를 설정할 필요는 없음
  - Spring 릴레이가 브로커에 연결할 때 서버 쪽에서 설정한 계정이 사용되며, 클라이언트 헤더는 기본적으로 무시됨
- 사용 목적지 접두사가 브로커가 지원하는 접두사와 맞아야 함
  - 외부 브로커가 `/exchange/...`, `/amq/queue/...`등 다른 규칙을 가진다면 Spring 설정도 이에 맞춰야 함
- 외부 브로커 릴레이는 Simple Broker보다 고급 기능을 지원하는 반면, 이 모든 기능이 자동으로 활성화되지는 않을 수 있어 추가 설정이 필요할 수 있음