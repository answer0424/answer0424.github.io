---
layout: post
title: External Broker
date: 2025-10-23 09:00:00 +09:00
categories: [Spring, Servlet Stack, Web MVC, WebSockets, STOMP]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## 개요

- Spring이 제공하는 내장형 단순 브로커 대신, 실제 메시지 브로커를 STOMP 릴레이 방식으로 연결해 메시지 송수신을 처리할 수 있음
- 이 방식에서는 Spring이 브로커와 TCP 연결을 맺고 클라이언트들과 WebSocket/STOMP 통신을 유지하면서 메시지를 브로커에 전달하고 브로커에서 받은 메시지를 다시 WebSocket 클라이언트에게 전달하는 중계 역할을 수행하게 됨
- 따라서 여러 서버에 걸쳐 있는 클라이언트들, 고가용성 환경, 대량 메시지 발송 등 확장성 및 신뢰성이 요구되는 시스템에서 적합한 방식

<br>

## 설정 방식

```java
@Configuration
@EnableWebSocketMessageBroker
public class WebSocketConfig implements WebSocketMessageBrokerConfigurer {

    @Override
    public void registerStompEndpoints(StompEndpointRegistry registry) {
        registry.addEndpoint("/ws-endpoint").withSockJS();
    }

    @Override
    public void configureMessageBroker(MessageBrokerRegistry registry) {
        registry.enableStompBrokerRelay("/topic/", "/queue/")
                // 추가 설정 가능: .setRelayHost("broker.example.com")
                // .setRelayPort(61613).setClientLogin("user").setClientPasscode("pass");
                ;
        registry.setApplicationDestinationPrefixes("/app");
    }
}
```

- 위 설정에서 `enableStompBrokerRelay("/topic", "/queue")`를 통해 외부 브로커 릴레리를 활성화함

```xml
<websocket:message-broker application-destination-prefix="/app">
  <websocket:stomp-endpoint path="/ws-endpoint">
    <websocket:sockjs/>
  </websocket:stomp-endpoint>
  <websocket:stomp-broker-relay prefix="/topic,/queue"
                                relay-host="broker-host"
                                relay-port="61613"
                                client-login="user"
                                client-passcode="pass"/>
</websocket:message-broker>
```


<br>