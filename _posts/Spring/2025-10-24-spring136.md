---
layout: post
title: Connecting to a broker
date: 2025-10-24 09:00:00 +09:00
categories: [Spring, Servlet Stack, Web MVC, WebSockets, STOMP]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## 개요

- 외부 메시지 브로커를 STOMP 릴레이 방식으로 연동할 때, 다음과 같은 상세 옵션들을 구성할 수 있음
- 이 설정은 `registry.enableStompBrokerRelay(..)` 메서드를 호출한 뒤 추가적으로 구성하는 방식

| 옵션                                           | 설명                                                                                     |
| ---------------------------------------------- | ---------------------------------------------------------------------------------------- |
| `systemLogin(String)`/`systemPasscode(String)` | 서버 어플리케이션이 브로커에 연결할 때 사용할 시스템 계정                                |
| `clientLogin(String)`/`clientPasscode(String)` | WebSocket 클라이언트 한 명당 브로커로 생성되는 TCP 연결에 사용되는 계정                  |
| `virtualHost(String)`                          | 브로커 연결 시 `CONNECT` 프레임의 `host` 헤더에 들어갈 값                                |
| `heartbeatValue(long[])`                       | 서버 ↔️ 브로커 간 heartbeat 주기를 설정 가능                                              |
| `setTcpClient(...)`                            | 커스텀 TCP 클라이언트를 지정해 여러 브로커 주소 풀링, SSL 설정, 로드밸런싱 등을 구현가능 |

<br>

## 예시 설정

```java
@Configuration
@EnableWebSocketMessageBroker
public class WeSocketConfig implements WebSocketMessageBrokerConfigurer {

    @Override
    public void registerStompEndpoints(StompEndpointRegistry registry) {
        registry.addEndpoint("/ws-endpoint")
                .setAllowedOrigins("*")
                .withSockJS();
    }

    @Override
    public void configureMessageBroker(MessageBrokerRegistry registry) {
        registry.enableStompBrokerRelay("/topic/", "/queue/")
                .setRelayHost("broker.example.com")
                .setRelayPort(61613)
                .setClientLogin("clientUser")
                .setClientPasscode("clientPass")
                .setSystemLogin("systemUser")
                .setSystemPasscode("systemPass")
                .setVirtualHost("myVirtualHost")
                .setHeartbeatValue(new long[] {10000, 10000})
                .setTcpClient(createTcpClient());
        registry.setApplicationDestinationPrefixes("/app");
    }

    private ReactorNettyTcpClient<byte[]> createTcpClient() {
        return new ReactorNettyTcpClient<>(
            client -> client.addressSupplier(() -> new InetSocketAddress("broker-backup", 61613)),
            new StompReactorNettyCodec()
        );
    }
}
```