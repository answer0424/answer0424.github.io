---
layout: post
title: User Destination
date: 2025-10-24 09:00:00 +09:00
categories: [Spring, Servlet Stack, Web MVC, WebSockets, STOMP]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---


## 개요 

- User Destination은 특정 사용자에게만 메시지를 보내는 방식을 지원하는 기능
- 클라이언트가 예컨대 `/user/queue/position-updates`와 같이 구독하면 서버는 이를 내부적으로 사용자 세션마다 고유한 실제 목적지로 매핑함
- 이 구조 덕분에 여러 사용자가 동일한 구독 목적지 경로를 사용하더라도 서로 메시지가 충돌하지 않고 각 사용자는 자신만의 구독을 갖게 됨

<br>

## 주요 기능 및 사용법

#### 구독 측면 (클라이언트)

- 클라이언트가 `/user/queue/position-updates` 같은 경로로 구독하면, Spring 내부에서는 이 경로를 세션 식별자를 붙인 고유 경로로 바꿔서 구독을 관리
- 즉, 클라이언트는 별도의 사용자 식별 없이 `/user/...` 경로를 사용하면 되고, 서버 쪽에서 자동으로 사용자 식별 및 매핑이 됨

<br>

#### 발송 측면 (서버)

- 서버에서 특정 사용자에게 메시지를 보내고자 할 때는 다음과 같은 방식이 사용

```java
@Service
public class TradeServiceImpl {
    private final SimpMessagingTemplate messagingTemplate;
    @Autowired
    public TradeServiceImpl(SimpMessagingTemplate messagingTemplate) {
        this.messagingTemplate = messagingTemplate;
    }
    public void afterTradeExecuted(Trade trade) {
        this.messagingTemplate.convertAndSendToUser(
            trade.getUserName(), "/queue/position-updates", trade.getResult());
    }
}
```

> 위 코드는 `userName`이라는 사용자 이름을 알아낼 수 있을 때 해당 사용자에게 `/queue/position-updates` 경로로 메시지를 전송하는 예제

<br>

- 또한 컨트롤러 메서드에서 응답으로 특정 사용자에게만 보내는 경우에는 `@SendToUser` 어노테이션을 사용할 수 있음

```java
@Controller
public class PortfolioController {
    @MessageMapping("/trade")
    @SendToUser("/queue/position-updates")
    public TradeResult executeTrade(Trade trade, Principal principal) {
        // …
        return tradeResult;
    }
}
```

<br>

#### 여러 세션 사용자 고려

- 한 사용자가 여러 WebSocket 세션으로 접속한 상태라면, 기본적으로는 모든 세션에 메시지가 전송
- 만약 메시지를 요청한 세션 하나에만 보내고 싶다면 `@SendToUser(destinations="/queue/errors", broadcast=false)` 와 같이 `broadcast=false` 설정을 사용할 수 있음

<br>

## 유의사항 및 팁

- `"/user/"` 접두사를 사용하는 목적지는 메시지 브로커 설정에서 적절히 구성되어야 함
  - 즉, `applicationDestinationPrefixes` 또는 브로커 접두사 설정이 올바르지 않으면 브로커가 `/user/` 경로를 처리하게 되어 `UserDestinationMessageHandler`가 개입하지 못하는 경우가 생김
- 외부 메시지 브로커를 사용하는 환경에서는 사용자 별 고유 큐가 세션 종료 시 자동 삭제되도록 브로커 설정을 확인해야 함
  - 예컨데 RabbitMQ에서 `/exchange/amq.direct/...`과 같이 설정했을 경우 자동 삭제 설정이 중요
- 인증된 사용자를 사용할 경우에 더 유용하지만 인증이 없는 세션이라도 `/user/...` 구독이 가능하며 이 경우는 해당 세션만을 타겟팅하는 형태로 동작하게 됨
- 프론트엔드에서는 `stompClient.subscribe('/user/queue/position-updates', …)`와 같은 경로로 구독하면되며, 독립적인 세션별 주소를 알 필요없이 편리
- 서버 측에서는 `convertAndSendToUser(...)` 또는 `@SendToUser` 등을 통해 사용자별 메시지 전송을 설계하면 구조가 깔끔해짐