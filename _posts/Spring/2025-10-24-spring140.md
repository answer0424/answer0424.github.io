---
layout: post
title: User Destination
date: 2025-10-24 09:00:00 +09:00
categories: [Spring, Servlet Stack, Web MVC, WebSockets, STOMP]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---


## 개요 

- User Destination은 특정 사용자에게만 메시지를 보내는 방식을 지원하는 기능
- 클라이언트가 예컨대 `/user/queue/position-updates`와 같이 구독하면 서버는 이를 내부적으로 사용자 세션마다 고유한 실제 목적지로 매핑함
- 이 구조 덕분에 여러 사용자가 동일한 구독 목적지 경로를 사용하더라도 서로 메시지가 충돌하지 않고 각 사용자는 자신만의 구독을 갖게 됨

<br>

## 주요 기능 및 사용법

#### 구독 측면 (클라이언트)

- 클라이언트가 `/user/queue/position-updates` 같은 경로로 구독하면, Spring 내부에서는 이 경로를 세션 식별자를 붙인 고유 경로로 바꿔서 구독을 관리
- 즉, 클라이언트는 별도의 사용자 식별 없이 `/user/...` 경로를 사용하면 되고, 서버 쪽에서 자동으로 사용자 식별 및 매핑이 됨

<br>

#### 발송 측면 (서버)

- 서버에서 특정 사용자에게 메시지를 보내고자 할 때는 다음과 같은 방식이 사용

```java
@Service
public class TradeServiceImpl {
    private final SimpMessagingTemplate messagingTemplate;
    @Autowired
    public TradeServiceImpl(SimpMessagingTemplate messagingTemplate) {
        this.messagingTemplate = messagingTemplate;
    }
    public void afterTradeExecuted(Trade trade) {
        this.messagingTemplate.convertAndSendToUser(
            trade.getUserName(), "/queue/position-updates", trade.getResult());
    }
}
```

> 위 코드는 `userName`이라는 사용자 이름을 알아낼 수 있을 때 해당 사용자에게 `/queue/position-updates` 경로로 메시지를 전송하는 예제

<br>

- 또한 컨트롤러 메서드에서 응답으로 특정 사용자에게만 보내는 경우에는 `@SendToUser` 어노테이션을 사용할 수 있음

```java
@Controller
public class PortfolioController {
    @MessageMapping("/trade")
    @SendToUser("/queue/position-updates")
    public TradeResult executeTrade(Trade trade, Principal principal) {
        // …
        return tradeResult;
    }
}
```

<br>

#### 여러 세션 사용자 고려

- 한 사용자가 여러 WebSocket 세션으로 접속한 상태라면, 기본적으로는 모든 세션에 메시지가 전송
- 만약 메시지를 요청한 세션 하나에만 보내고 싶다면 `@SendToUser(destinations="/queue/errors", broadcast=false)` 와 같이 `broadcast=false` 설정을 사용할 수 있음