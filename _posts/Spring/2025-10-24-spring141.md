---
layout: post
title: Authentication
date: 2025-10-24 09:00:00 +09:00
categories: [Spring, Servlet Stack, Web MVC, WebSockets, STOMP]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## 이벤트 별 정리

#### `BrokerAvailabilityEvent`

- 무엇: 브로커의 가용성 변경 시 발행
- 유용 시점: `SimpMessagingTemplate` 등으로 메시지 보낼 때 브로커가 사용 가능한지 판단하려면 구독
- 핵심 처리: 메시지 발송을 브로커 상태에 따라 중단/큐잉하거나 에러 처리
- 주의점: 브로커 상태 변화에 대한 이벤트이며, 클라이언트 세션 이벤트와는 별개

<br>

#### `SessionConnectEvent`

- 무엇: 클라이언트가 STOMP `CONNECT` 프레임을 보낸 즉시 발행
- 들어있는 정보: 전송된 메시지(헤더 포함) — 세션ID, 사용자 Principal, 커스텀 헤더 등
- 활용: 접속 시 로깅, 세션 초기화, 인증/권한 검사 보조 등
- 주의: CONNECT를 보낸 직후라 아직 CONNECTED 응답 전일 수 있음

<br>

#### `SessionConnectedEvent`

- 무엇: STOMP 세션이 실제로 성립되어 CONNECTED 응답이 완료된 시점에 발행
- 활용: 환영 메시지 전송, 구독 초기화, 세션을 본격 서비스에 등록하는 시점으로 사용
- 주의: SessionConnectEvent와는 시점 차이가 있으므로 둘을 혼동하지 말 것

<br>

#### `SessionSubscribeEvent`

- 무엇: 클라이언트가 STOMP `SUBSCRIBE` 프레임을 보낼 때 발행
- 활용: 누가 어떤 destination을 구독했는지 추적
- 주의점: SUBSCRIBE 요청 자체에 대한 이벤트이므로, 실제 구독 승인/거부 여부는 별도 로직 필요

<br>

#### `SessionUnsubscribeEvent`

- 무엇: 클라이언트가 `UNSUBSCRIBE` 프레임을 보낼 때 발행
- 활용: 구독 취소 감지 ➡️ 리소스 해제, 내부 트래킹 정리 등
- 주의점: 자동 취소나 여러 경로로 중복 발생 가능 - idempotency 고려

<br>

#### `SessionDisconnectEvent`

- 무엇: 세션 종료 시 발행
- 활용: 세션 정리, 로그, 통계 업데이트
- 주의점: 동일 세션에서 같은 이벤트가 여러 번 발생할 수 있음 - 중복 처리 안전하게 구현해야 함. 또한 브로커 상태 변화와 혼동하지 말 것

<br>

## 실무 핵심 팁

- 리스너 등록: `@EventListener` 또는 `ApplicationListener` 사용
- 헤더 접근: `SimpMessageHeaderAccessor`/`StompHeaderAccessor`로 세션 ID, 사용자, 헤더 추출
- 멱등 처리: `SessionDisconnectEvent` 같은 이벤트는 여러번 발생 가능하므로 이미 정리된 리소스 재정리하지 않도록 방어 로직이 필요
- 브로커 분리 고려: 내부 broker와 외부 broker 는 동작 가용성 특정이 달라 `BrokerAvailabilityEvent` 처리 로직도 달라야 할 수 있음

<br>

## 예제


```java
@EventListener
public void handleBroker(BrokerAvailabilityEvent ev) {
    boolean available = ev.isBrokerAvailable();
}

@EventListener
public void handleDisconnect(SessionDisconnectEvent ev) {
    String sessionId = SimpMessageHeaderAccessor.wrap(ev.getMessage()).getSessionId();
}
```

<br>

## 요약

> STOMP/WebSocket에서 발생하는 이벤트 (`CONNECT`, `CONNECTED`, `SUBSCRIBE`, `UNSUBSCRIBE`, `DISCONNECT`, `BrokerAvailability`)를 적절히 구독해 세션,구독 상태 추적, 브로커 오류 대응, 멱등성 있는 정리 로직을 구현하면 실시간 메시징 시스템의 안정성과 관측성이 크게 향상됨