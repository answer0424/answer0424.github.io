---
layout: post
title: WebSocket Scope
date: 2025-10-27 09:00:00 +09:00
categories: [Spring, Servlet Stack, Web MVC, WebSockets, STOMP]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## 개요

- 각 WebSocket 세션은 세션별로 속성 맵을 갖음
- 그 맵은 인바운드 메시지의 헤더에 첨부되어 컨트롤러 메서드 등에서 접근할 수 있음
- 또한 웹소켓 스코프라는 커스텀 빈 스코프를 정의하여, 세션 당 빈이 생성되고 해당 세션이 종료될 때 소멸되도록 할 수 있음

<br>

## 주요 기능 및 사용 방법

#### 1. 세션 속성 접근

```java
@Controller
public class MyController {

    @MessageMapping("/action")
    public void handle(SimpMessageHeaderAccessor headerAccessor) {
        Map<String, Object> sessionAttributes = headerAccessor.getSessionAttributes();
        // 세션 속성 사용
    }
}
```
- 이 코드로 해당 WebSocket 세션의 속성 맵을 가져올 수 있음

<br>

#### 2. `websocket` 스코프 빈 정의

```java
@Component
@Scope(scopeName = "websocket", proxyMode = ScopedProxyMode.TARGET_CLASS)
public class MyBean {
    @PostConstruct
    public void init() {
        // 초기화 로직
    }

    @PreDestroy
    public void destroy() {
        // 소멸 로직
    }
}
```

- 컨트롤러나 인바운드 채널 인터셉터 등 싱글턴 빈이 주로 살아 있는 컴포넌트에서 이 세션 스코프 빈을 주입하여 세션별 인스턴스로 사용할 수 있음

<br>

#### 3. 생명 주기 및 동작 방식

- 웹소켓 스코프 빈은 해당 WebSocket 세션에서 처음 접근된 시점에 생성되고, 그 세션이 끝날 때까지 같은 인스턴스가 재사용됨
- 세션 종료 시 `@PreDestroy` 메서드가 호출되어 정리 작업 가능
- 이렇게 함으로써, 세션별 상태를 빈으로 유지하면서도 싱글턴 빈 구조에서도 세션별 변수/상태를 관리할 수 있게 됨

<br>

## 실무 팁 & 유의사항

- 세션 속성 맵을 사용해 사용자별 또는 세션 별 상태 관리를 할 수 있음
- `websocket` 스코프 빈을 사용할 경우, 프록시 설정이 필요 - 싱글턴 빈에 주입될 때 스코프 문제가 발생하지 않도록 하기 위함
- 세션이 언제 종료되는가를 잘 이해하고 있어야 `@PreDestroy` 메서드가 적절히 호출되는지 확인할 수 있음
- 여러 세션에서 동일 빈을 사용하면 안되고, 세션마다 별도 인스턴스가 생성되어야 할 때 이 스코프가 유용
- 성능 및 리소스 측면에서, 빈을 세션별로 많이 생성하면 비용이 발생할 수 있으므로 꼭 필요한 경우에만 사용을 고려할 것