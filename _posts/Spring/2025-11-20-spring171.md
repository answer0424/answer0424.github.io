---
layout: post
title: Asynchronous Requests
date: 2025-11-20 09:00:00 +09:00
categories: [Spring, Reactive Stack, WebFlux]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---


## 개요

- Spring MVC는 Servlet 3.0 이상이 제공하는 비동기 요청 처리 기능을 적극적으로 통합하고 있음
- 이를 통해 컨트롤러 메서드가 요청 처리 스레드를 바로 차지하지 않고, 나중에 결과를 설정하거나 스트리밍하는 방식으로 응답을 제공할 수 있음
- 주요 반환 타입으로는 DeferredResult, Callable, WebAsyncTask 등이 있으며, 스트리밍 응답을 위해 ResponseBodyEmitter, SseEmitter, StreamingResponseBody 등이 지원됨
- 또한, 리엑티브 타입을 컨트롤러 반환값으로 사용하는 것이 가능하며, 내부에서는 DeferredResult 또는 스트리밍 방식으로 변환되어 처리됨

<hr>

## 주요 처리 유형 및 사용 방식

#### `Callable`

- 컨트롤러 메서드가 즉시 응답값을 반환하지 않고, `Callable<V>` 형태로 반환함으로써 별도 스레드에서 처리하게 할 수 있음

```java
@GetMapping("/callable")
public Callable<String> handle() {
    return () -> {
        // 장시간 처리
        Thread.sleep(10000);
        return "asynchronous request completed";
    };
}
``` :contentReference[oaicite:13]{index=13}  
```

- 처리 흐름: 요청 ➡️ DispatcherServlet에서 비동기모드 시작 ➡️ `Callable` 실행 ➡️ 결과 리턴 ➡️ 다시 Servlet 컨테이너로 디스패치 ➡️ 응답 완료

<br>

#### `DeferredResult`

- 컨트롤러 메서드가 `DeferredResult<V>`를 반환하고 이후 다른 쓰레드나 이벤트에서 `deferredResult.setResult(V result)` 혹은 `setErrorResult(...)`를 호출하여 응답을 마무리하는 방식임

```java
@GetMapping("/quotes")
@ResponseBody
public DeferredResult<String> quotes() {
    DeferredResult<String> deferredResult = new DeferredResult<>();
    // 어떤 외부 이벤트 또는 스케줄러에서 결과 설정...
    return deferredResult;
}
```

<br>

#### `WebAsyncTask`

- `Callable` 방식 위에 타임아웃 설정, 별도 `AsyncTaskExecutor` 지정과 같은 추가 기능을 제공하는 래퍼 타입

```java
@GetMapping("/callable")
WebAsyncTask<String> handle() {
    return new WebAsyncTask<>(20000L, () -> {
        Thread.sleep(10000);
        return "asynchronous request completed";
    });
}
```

<br>

#### HTTP 스트리밍 및 SSE

- 하나의 요청에 대해 여러 개의 응답 또는 서버에서 이벤트 푸시 방식이 필요할 경우 `ResponseBodyEmitter`, `SseEmitter`등이 지원됨
- 예: `SseEmitter`를 반환하여 서버에서 여러 번 `emitter.send()` 호출, 마지막에 `emitter.complete()` 호출
- 또는 `StreamingResponseBody`를 반환하여 OutPutStream을 통해 바이트 스트림을 직접 쓰는 경우


<hr>

## 설정 및 구성

- 서블릿 컨테이너 수준에서 비동기 처리를 지원해야 하며, `DispatcherServlet` 및 관련 `Filter` 선언에 `<async-supported>true</async-supported>`가 필요
- Spring MVC 설정상에서는 `WebMvcConfigurer`의 `configureAsyncSupport()` 메서드를 사용하여 타임아웃, `AsyncTaskExecutor`, 인터셉터등을 설정할 수 있음
- 기본 타입 아웃 값은 서블릿 컨테이너에 따라 다르며, 필요 시 명시적으로 설정해 주는 것이 좋음

<hr>

## 중요 유의사항 및 비교

- `Callable`, `DeferredResult` 방식은 요청 처리에 사용되는 메인 서블릿 스레드를 빠리 해제할 수 있어, 장시간 처리 작업이나 외부 비동기 이벤트 처리에 유리함
- 그러나 이 방식은 완전한 non-blocking I/O 모델이 아님
  - 특히  스트리밍 시 각 writet는 별도 스레드에서 blocking I/O 형태로 동작하며, Spring WebFlux 스택의 non-blocking I/O와는 차이가 존재
- 비동기 요청 처리 시 `ThreadLocal`, `RequestAttributes` 등의 컨텍스트 전파가 별도로 고려되어야 함
- 스트리밍 응답을 구현할 때 클라이언트가 연결을 끊을 가능성에 대비해야 하며, 적절한 “heartbeat” 유발 또는 WebSocket 방식 고려가 권고

<hr>

## 동작 방식

- 요청 헤더 `Range`가 존재할 경우, Spring MVC는 내부적으로 HttpRange 클래스를 사용해 헤더를 파싱하고, `Resource` 객체를 필요한 범위만큼 잘라낸 `List<ResourceRegion>` 형태로 분할함
- 컨트롤러 메서드가 `Resource` 또는 `ResponseEntity<Resource>` 타입을 반환할 때 이 지원이 자동으로 적용됨
- 반환된 `Resource`가 `InputStreamResource` 이어서는 안됨
- `ResponseEntity<Resource>` 형태일 경우 응답 상태가 200이어야 함