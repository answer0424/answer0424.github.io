---
layout: post
title: CORS
date: 2025-11-21 09:00:00 +09:00
categories: [Spring, Reactive Stack, WebFlux]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## 개요

- CORS는 브라우저가 기본적으로 적용하는 동일 출처 정책을 우회하여 다른 출처의 자원을 요청할 수 있도록 허용하는 메커니즘임
- Spring MVC는 CORS 요청을 지원하기 위한 통합 구조를 제공함
- 요청이 핸들러된 후 `HandlerMapping` 구현체가 해당 요청에 대해 CORS 설정을 확인하고, 미리 지정된 CORS 설정이 없으면 응답에 CORS 헤더를 추가하지 않음 ➡️ 결과적으로 브라우저가 요청을 거부할 수 있음

<hr>

## 주요 기능 및 설정 방식

#### 어노테이션 방식: `@CrossOrigin`

- 특정 컨트롤러 클래스나 메서드 수준에서 CORS를 허용하고자 할 때 사용함
- 기본 설정으로는 다음이 허용됨
  - 모든 출처(origins) 허용
  - 모든 헤더(headers) 허용
  - 컨트롤러 메서드에 매핑된 HTTP 메서드들 허용
- 설정 가능한 속성들 예: `origins`, `originPatterns`, `methods`, `allowedHeaders`, `exposeHeaders`, `allowCredentials`, `maxAge`

```java
@RestController
@RequestMapping("/account")
public class AccountController {
    @CrossOrigin
    @GetMapping("/{id}")
    public Account retrieve(@PathVariable Long id) {
        // …
    }
}
```

- 클래스 수준에 붙여서 전체 메서드에 적용할 수도 있고, 메서드 수준에 별도로 지정할 수도 있으며, 클래스 + 메서드 두 수준 다 지정 가능하고 이 경우 설정이 병합됨

<br>

#### 전역 설정(글로벌 CORS 설정)

- 어노테이션 방식 외에, 어플리케이션 전체 또는 특정 URL 패턴에 대해 CORS 설정을 일괄적으로 적용할 수 있음

```java
@Configuration
@EnableWebMvc
public class WebConfig implements WebMvcConfigurer {
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/api/**")
                .allowedOrigins("https://domain2.com")
                .allowedMethods("GET", "POST")
                .allowedHeaders("*")
                .exposedHeaders("header1", "header2")
                .allowCredentials(true)
                .maxAge(3600);
    }
}
```

<hr>

## 주요 설정 항목 및 의미

- `allowedOrigins`: 허용할 출처. `"*"`로 지정하면 모든 출처 허용이지만 보안상 주의해야 함
- `allowedMethods`: 허용할 HTTP 메서드들
- `allowedHeaders`: 클라이언트 요청 헤더 중 허용할 헤더들
- `exposedHeaders`: 응답에서 클라이언트가 접근 가능하도록 노출할 헤더
- `allowCredentials`: 자격증명이 포함된 요청을 허용할지 여부. 기본은 `false`이며, `true`로 설정 시 허용되는 origin을 명시해야 함
- `maxAge`: 브라우저가 Preflight 요청을 캐싱할 수 있는 최대 시간
- `originPatterns`: 유동적인 여러 출처 패턴 매칭이 필요할 경우 사용 가능

<hr>

## 처리 흐름 및 동작 방식

- 브라우저가 다른 출처에 요청을 보내면 먼저 Preflight 요청이 발생할 수 있음
- 서버는 이 요청에 대해 CORS 설정에 따라 적절한 `Access-Control-Allow-*` 헤더를 포함한 응답을 보내야 하며, 그렇지 않으면 브라우저가 실제 요청을 취소함
- Spring MVC에서 `HandlerMapping`이 요청을 매핑한 뒤 CORS 설정을 검사하고 적용 가능한 경우에는 CORS 처리기가 동작하여 응답 헤더를 설정함
  - Preflight는 바로 처리,완료될 수 있고, 실제 요청/단순 요청은 헤더를 추가한 뒤 컨트롤러가 실행될 수 있음 

<hr>

## 사용 시기

- 프론트엔드 어플리케이션이 다른 도메인 또는 포트에서 백엔드 API를 호출할 때 SOP로 인해 요청이 차단될 수 있는데 CORS 설정은 필수적임
- REST API를 외부 또는 다양한 클라이언트에서 호출하도록 설계할 경우, CORS 설정은 필수적임
- 보안 측면에서 허용할 출처, 메서드, 헤더 등을 명확히 제어함으로써 교차 도메인 요청에 대한 리스크를 줄일 수 있음 

<hr>

## 유의사항 및 팁

- `allowCredentials=true` 설정 시에는 `allowedOrigins="*"` 같이 모든 출처 허용으로 지정하면 안됨
  - 브라우저가 이를 거부하거나 보안 이슈가 될 수 있음
- `@CrossOrigin` 또는 글로벌 설정만으로는 Spring Security 또는 다른 필터 설정과 충돌이 있을 수 있으므로, 보안 프레임워크 등을 사용하는 경우에는 CORS 설정이 인증 이전에 처리되도록 유의해야 함
- Preflight 요청을 허용하도록 `allowedMethods`에 OPTIONS를 포함하거나, 글로벌 설정에서 기본으로 허용되는 메서드 범위를 확인해야 함
- 브라우저에서 CORS 오류가 발생할 때는 요청 헤더 `Origin`, 응답 헤더 `Access-Control-Allow-Origin` 등이 올바르게 설정됐는지 확인해야 함
  - Postman 등에서는 SOP가 적용되지 않기 때문에 성공하지만, 실제 브라우저에서는 거부될 수 있음