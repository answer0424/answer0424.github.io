---
layout: post
title: WebClient Configuration
date: 2025-11-24 09:00:00 +09:00
categories: [Spring, Reactive Stack, WebClient]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## WebClient Builder

#### WebClient 생성 방법

```java
WebClient webClient = WebClient.builder()
WebClient clientBase = WebClient.create("https://api.example.com");
```

- 더 많은 설정이 필요하면 `WebClient.builder()`를 사용
- Builder로 생성된 WebClient는 불변
  - 설정된 WebClient를 복제해 변경하고 싶다면 `mutate()` 사용 가능

```java
WebClient client1 = WebClient.builder()
    .filter(filterA)
    .filter(filterB)
    .build();

WebClient client2 = client1.mutate()
    .filter(filterC)
    .filter(filterD)
    .build();
// client2는 A, B, C, D 필터 모두 가지고 있음
```

<br>

#### Builder에서 설정 가능한 주요 옵션

| 옵션 | 설명 |
|-|-|
| ruiBuilderFactory | 기본 URI 빌더 팩토리 설정 |
| defaultUriVariables | URI 템플릿에 사용할 기본 변수값 지정 |
| defaultHeaders | URI 템플릿에 사용할 기본 변수값 지정 |
| defaultCookie | 모든 요청에 포함될 기본 쿠키 설정 |
| defaultRequest | `Consumer`를 이용해 모든 요청에 공통으로 커스터마이징 적용 |
| filter | `ExchangeFilterFunction` 필터 등록, 요청/응답 가로채기 가능 |
| exchangeStrategies | HTTP 메시지 인코더/디코더 설정 변경. 버퍼 크기 조정 등 가능 |
| clientConnector | HTTP 클라이언트 커넥터 설정 |
| defaultApiVersion | API 버즌을 모든 요청에 기본값으로 넣는 기능 |
| apiVersionInserter | API 버전을 요청에 어떻게 삽입할지 전략 설정 가능 |
| observationRegistry/observationConvention | 관측용 설정 |

<br>

#### 메시지 코덱 설정

- WebClient가 사용하는 `ExchangeStrategies`를 통해 코덱 설정을 바꿀 수 있음

```java
WebClient webClient = WebClient.builder()
    .codecs(configurer -> configurer.defaultCodecs().maxInMemorySize(2 * 1024 * 1024))
    .build();
```

<br>

#### HTTP 클라이언트 커넥터 설정

- 기본적으로 Reactor Netty를 사용하지만, `ClientHttpConnector`를 직접 지정 가능함

```java
HttpClient httpClient = HttpClient.create().secure(sslSpec -> {
    // SSL 설정 커스터마이징
});

WebClient webClient = WebClient.builder()
    .clientConnector(new ReactorClientHttpConnector(httpClient))
    .build();
```

- 타임아웃 설정 예시

```java
HttpClient httpClient = HttpClient.create()
    .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, 10000)
    .doOnConnected(conn -> conn
        .addHandlerLast(new ReadTimeoutHandler(10))
        .addHandlerLast(new WriteTimeoutHandler(10))
    );

WebClient webClient = WebClient.builder()
    .clientConnector(new ReactorClientHttpConnector(httpClient))
    .build();
```

- 응답 타임아웃 설정도 가능

```java
HttpClient httpClient = HttpClient.create()
    .responseTimeout(Duration.ofSeconds(2));

WebClient webClient = WebClient.builder()
    .clientConnector(new ReactorClientHttpConnector(httpClient))
    .build();
```

<br>

#### WebClient 복제와 Mutability

- Builder로 만든 Webclient는 immutable
- 기존 WebClient 인스턴스를 복제할 때는 `mutate()`를 사용하면 새 설정을 추가 가능

```java
WebClient baseClient = WebClient.builder()
    .filter(filterA)
    .build();

WebClient anotherClient = baseClient.mutate()
    .filter(filterB)
    .build();
```

<hr>

## 예시 

```java
WebClient webClient = WebClient.builder()
    .baseUrl("https://api.example.com")  // 기본 URL
    .defaultHeader(HttpHeaders.AUTHORIZATION, "Bearer your-token")
    .defaultCookie("SESSIONID", "abcd1234")
    .codecs(configurer -> configurer.defaultCodecs().maxInMemorySize(2 * 1024 * 1024))
    .clientConnector(new ReactorClientHttpConnector(
        HttpClient.create()
            .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, 5000)
            .responseTimeout(Duration.ofSeconds(5))
    ))
    .filter((request, next) -> {
        // 요청 로깅 같은 공통 필터
        System.out.println("Request: " + request.url());
        return next.exchange(request);
    })
    .build();
```

<hr>

## 주의할 점

- 코덱은 메모리 설정을 너무 작게하면 대용량 응답에서 `DataBufferLimitException` 이 발생할 수 있으니 필요에 따라 조절할 것
- 커넥터 설정 시 Reactor Netty 외에 다른 HTTP 라이브러리 사용 가능 ➡️ 필요에 따라 SSL, 타임아웃 등을 직접 제어하면 좋음
- 공통 헤더나 쿠키, 요청 필터는 Builder 단계에서 설정하면 모든 요청에 일괄 적용 가능
- `mutate` 기능을 활용하여 기본 WebClient를 기반으로 다양한 변형을 만들어 재사용할 수 있음