---
layout: post
title: Retrieve()
date: 2025-11-24 09:00:00 +09:00
categories: [Spring, Reactive Stack, WebClient]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## `retrieve()`란?

- WebClient 요청 후 응답을 받아서 응답 본문을 간단하게 추출하는 편리한 방식
- 내부적으로 `exchange()`를 호출하고 그 결과에서 본문만 디코딩해서 주는 shortcut 역할
- 기본적으로 HTTP 상태가 4xx, 5xx인 경우 `WebClientResponseException` 예외를 던짐
- 에러 응답을 커스터마이징하고 싶다면 `onStatus()` 핸들러를 제공할 수 있음

<hr>

## 주요 사용 시나리오 & 예시

#### 전체 응답을 `ResponseEntity`로 받기


```java
WebClient client = WebClient.create("https://example.org");

Mono<ResponseEntity<Person>> result = client.get()
    .uri("/persons/{id}", id)
    .accept(MediaType.APPLICATION_JSON)
    .retrieve()
    .toEntity(Person.class);
```

<br>

#### 단순 본문만 `Mono<T>`로 받기

```java

Mono<Person> result = client.get()
    .uri("/persons/{id}", id)
    .accept(MediaType.APPLICATION_JSON)
    .retrieve()
    .bodyToMono(Person.class);
```


<br>

#### 본문이 스트림(`Flux`)인 경우


```java
Flux<Quote> result = client.get()
    .uri("/quotes")
    .accept(MediaType.TEXT_EVENT_STREAM)
    .retrieve()
    .bodyToFlux(Quote.class);
```

<hr>

## 에러 처리 

- `retrieve()` 후 `onStatus()` 메서드를 통해 상태 코드 기반으로 에러 핸들링을 정의할 수 있음

```java
Mono<Person> result = client.get()
    .uri("/persons/{id}", id)
    .retrieve()
    .onStatus(HttpStatusCode::is4xxClientError, response ->
        response.bodyToMono(String.class)
                .flatMap(errorBody -> Mono.error(new RuntimeException("4xx Error: " + errorBody))))
    .onStatus(HttpStatusCode::is5xxServerError, response ->
        Mono.error(new RuntimeException("5xx server error")))
    .bodyToMono(Person.class);
```


<hr>

## 장점 & 한계 비교(`retrieve()` vs `exchange()`)

- 장점:
  - 코드가 간단하고 직관적 ➡️ 대부분 본문만 필요할 때 매우 유용
  - 자동으로 에러 응답 처리를 기본적으로 제공(`WebClientResponseException`) ➡️ 기본적인 상태 기반 에러 처리가 쉬움
- 한계:
  - 헤더나 상태 코드를 직접 다루기 어려움 ➡️ 만약 응답 헤더나 상태에 따라 복잡한 로직이 필요하면 `exchange()`가 더 유리함
  - `exchange()`는 직접 Response를 처리해야 하므로 메모리 누수 위험이 있지만 `retrieve()`는 그런 위험이 적음