---
layout: post
title: Filter
date: 2025-11-25 09:00:00 +09:00
categories: [Spring, Reactive Stack, WebClient]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## 개념

- WebClient에서 요청과 응답을 가로채고 조작할 수 있게 해주는 기능 ➡️ `ExchangeFilterFunction`을 사용
- WebClient의 필터는 `WebClient.Builder.filter()`를 통해 등록할 수 있고, WebClient를 생성할 때 적용됨
- 기존 WebClient 인스턴스를 복제해서 (`mutate()`) 필터를 추가하거나 제거할 수 있음

<hr>

## `ExchangeFilterFunction` 인터페이스

- 함수형 인터페이스로, 요청과 응답을 처리할 수 있음
- 메서드 시그니처

```java
Mono<ClientResponse> filter(ClientRequest request, ExchangeFunction next);
```

- 필터 체인을 구성할 수 있고, 여러 필터를 순서대로 적용 가능함
- 응답을 조작할 때는 반드시 응답 본문을 소비하거나 downstream으로 전달해야 함

<hr>

## 필터 사용 예시

#### 요청 헤더 추가

```java
WebClient client = WebClient.builder()
    .filter((request, next) -> {
        ClientRequest filtered = ClientRequest.from(request)
            .header("foo", "bar")
            .build();
        return next.exchange(filtered);
    })
    .build();
```


<br>

#### 기본 인증 필터

```java
import static org.springframework.web.reactive.function.client.ExchangeFilterFunctions.basicAuthentication;

WebClient client = WebClient.builder()
    .filter(basicAuthentication("user", "password"))
    .build();
```

<br>

#### 응답 상태 검사 + 재요청

```java
public ExchangeFilterFunction renewTokenFilter() {
    return (request, next) -> next.exchange(request)
        .flatMap(response -> {
            if (response.statusCode().value() == HttpStatus.UNAUTHORIZED.value()) {
                return response.releaseBody()
                    .then(renewToken())  // 토큰 갱신 로직
                    .flatMap(token -> {
                        ClientRequest newRequest = ClientRequest.from(request)
                            .header("Authorization", "Bearer " + token)
                            .build();
                        return next.exchange(newRequest);
                    });
            } else {
                return Mono.just(response);
            }
        });
}
```

<hr>

## 주의사항

- 필터에서 응답을 처리할 때 `flatMap()` 등으로 새 응답을 반환할 수 있지만, 기존 응답 바디를 완전히 읽거나 방출해야 안전함
- 인증, 로징, 에러 처리 같은 공통 관심사에 필터는 매우 유용함
- 필터는 WebClient 인스턴스 단일 구성 요소이므로 공통 WebClient 인스턴스를 여러 곳에서 쓰는 경우 필터 전략을 잘 설계하는 것이 좋음
- `mutate().filters()` API를 사용하면 기존 WebClient 인스턴스를 변경하지 않고 필터를 추가할 수 있음