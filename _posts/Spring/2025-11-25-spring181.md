---
layout: post
title: Context
date: 2025-11-25 09:00:00 +09:00
categories: [Spring, Reactive Stack, WebClient]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## 개요

- WebClient에서는 `attribute` 외에도 Reactor `Context`를 사용해 요청 간 상태를 전파할 수 있음
- `attribute`는 한 요청 단위에서 필터에 전달할 수 있는 정보용이고, 중첩 요청 또는 reactive 오퍼레이터 체인에서 이후 연산에도 영향을 주는 값은 `Context`를 사용하는 것이 적합함
- Reactor `Context`는 리액티브 스트림에서 key/value 형태로 보관되는 데이터 스토리지로 `contextWrite()`와 `deferContextual()` 같은 연산자와 함께 사용됨

<hr>

## 사용 예시

```java
WebClient client = WebClient.builder()
    .filter((request, next) ->
        Mono.deferContextual(contextView -> {
            String value = contextView.get("foo");
            return next.exchange(request);
        }))
    .build();

client.get().uri("https://example.org")
    .retrieve()
    .bodyToMono(String.class)
    .flatMap(body -> {
        return client.get().uri("/nasted").retrieve().bodyToMono(String.class);
    })
    .contextWrite(context -> context.put("foo", "bar"))
    .subscribe();
```

- 위 예시에서 
1. `filter()` 내부에서 `Mono.deferContextual()`를 통해 Reactor `Context`에 접근
2. 요청 체인의 마지막에 `.contextWrite()`를 사용해 `Context`에 `"foo"`라는 키로 값을 저장
3. 이후 `flatMap()` 등으로 중첩된 요청을 할 때도 해당 `Context`가 자동으로 전파됨 ➡️ 필터에서 같은 `Context`를 읽을 수 있음 