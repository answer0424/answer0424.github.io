---
layout: post
title: WebSocket
date: 2025-11-25 09:00:00 +09:00
categories: [Spring, Reactive Stack]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## 개요

- WebFlux는 리액티브 스트림 기반 웹 스택으로서, WebSocket을 통한 양방향 및 풀-듀플렉스 통신을 지원함
- 서버 측 설정, 클라이언트 측 사용, CORS나 업그레이드 전략 등 여러 세부사항을 다룸

<hr>

## 서버 설정(핸드셰이크 포함)

#### 핸드셰이크 처리

- `WebSocketHandlerAdapter` 빈이 요청 업그레이드를 처리함 이때 `WebSocketService`가 실제 전략을 제공함
- 기본적으로 `HandshakeWebSocketService` 구현체가 사용되며, 리액티브 서버 엔진에 맞는 `RequestUpgradeStrategy`를 전달할 수 있음

<br>

#### 설정 예시


```java
@Configuration
public class WebSocketConfig {
    @Bean
    public WebSocketHandlerAdapter handlerAdapter() {
        return new WebSocketHandlerAdapter(webSocketService());
    }

    @Bean
    public WebSocketService webSocketService() {
        TomcatRequestUpgradeStrategy upgradeStrategy = new TomcatRequestUpgradeStrategy();
        strategy.setMaxSessionIdleTimeout(0L); // 무제한 타임아웃
        return new HandShakeWebSocketService(strategy);
    }
}
```

- 위 처럼 업그레이드 전략, 세션 타임아웃 등의 커스터마이즈 가능 

<br>

#### CORS 설정

- WebSocket 엔드포인트에 대해 CORS를 설정하려면 `WebSocketHandler`가 `CorsConfigurationSource`를 구현하거나, `SimpleUrlHandlerMapping`의 `corsConfigurations` 속성으로 URL 패턴별 설정 가능

<hr>

## 핸들러 구현 및 메시지 교환 흐름

- 서버 측에서는 `WebSocketHandler` 인터페이스를 구현해야 함
- 주요 메서드: `Mono<Void> handle(WebSocketSession session)
  - `session.receive()` ➡️ 클라이언트로부터 들어오는 메시지 스트림
  - `session.send()` ➡️ 서버가 응답하거나 메시지를 내보내는 스트림

```java
@Service
public class MyWebSocketHandler implements WebSocketHandler {
    @Override
    public Mono<Void> handle(WebSocketSession session) {
        Flux<WebSocketMessage> output = session.receive()
            .map(WebSocketMessage::getPayloadsAsText)
            .map(texte -> text.toUpperCase())
            .map(session::textMessage);
        return session.send(output);
    }
}
```

- 위 예시는 클라이언트에서 보낸 텍스트 메시지를 받아서 대문자로 변환 후 다시 보내는 단순한 흐름임

<hr>

## 고려사항 

- WebSocket은 HTTP 요청 이후 업그레이드가 이루어지고, 연결이 지속되기 때문에 리소스 관리가 중요함
- 서버 엔진에 따라 업그레이트 전략 및 설정 가능한 옵셥이 다르므로 문서 확인 필요
- CORS, 인즈/인가 등을 WebSocket 연결 시점과 이후 메시지 흐름 모두 고려해야 함
- WebFlux 스택이기 때문에 블로킹 코드 삽입 시 성능 저하 가능성 있음