---
layout: post
title: TestExecutionListener
date: 2025-11-27 09:00:00 +09:00
categories: [Spring, Testing]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## 기본 리스너

| 리스너 이름 | 역할/책임 |
|-|-|
| `ServletTestExecutionListener` | Web 어플리케이션 테스트 시 Servlet API mock 설정 및 초기화. WebApplicationContext 기반 테스트 지원 |
| `DirtiesContextBeforeModesTestExecutionListener` | 테스트 전에 `@DirtiesContext` 어노테이션이 지정된 경우 "before" 모드 처리 |
| `ApplicationEventsTestExecutionListener` | Spring의 어플리케이션 이벤트 발행/처리를 테스트 컨텍스트 안에서 지원 |
| `DependencyInjectionTestExecutionListener` | 테스트 클래스에 `@Autowired`, `@Value` 등을 사용한 의존성 주입 지원 |
| `MicrometerObservationTestExecutionListerner` | 매트릭, 관측 레지스트리 설정을 지원 |
| `DirtiesContextTestExecutionListener` | `@DirtiesContext` 어노테이션이 지정된 경우 "after" 모드 처리 - 테스트 후 컨트롤러 / 재초기화 |
| `TransactionalTestExecutionListener` | 트랜잭션 관련 테스트 실행을 지원, 테스트 메서드 실행 전 트랜잭션 시작, 기본적으로 롤백, 필요 시 커밋 |
| `SqlScriptsTestExecutionListener` | `@Sql` 어노테이션을 처리해 테스트 실행 전후에 SQL 스크립트를 실행 |
| `EventPublishingTestExecutionListener` | 테스트 컨텍스트 내에서 이벤트 발행 기능을 지원 |

<hr>

## 리스너 커스터마이즈 및 설정 방법

#### `@TestExecutionListeners` 어노테이션 사용

- 테스트 클래스 또는 그 하위 클래스, 중첩 클래스 등에 대해 커스텀 `TestExecutionListener`를 지정할 수 있음

```java
@TestExecutionListeners(
  listeners = MyCustomListener.class,
  mergeMode = MergeMode.MERGE_WITH_DEFAULTS
)
public class MyTest { … }
```

- `mergeMode = MERGE_WITH_DEFAULTS`를 지정하면, 기본 리스너 세트와 커스텀 리스터를 병합해서 사용
- 만약 기본 리스너를 완전히 대체하고 싶다면 `inheritListeners = false` + 빈 listeners 배열로 지정 가능

<hr> 

## 리스너 등록 시 유의사항 & 팁

- 기본 리스너 집합은 `spring-test` 모듈의 `spring.factories` 파일을 통해 자동 등록됨
  - 따라서 일반적인 테스트에서는 별도 리스너 지정없이도 위 기능들이 동작함
- 커스텀 리스너를 추가할 경우, 반드시 정렬과 병합 방식을 고려해야 함
  - 기본 리스너 순서나 `@Order`/`Ordered` 구현 여부에 따라 동작이 달라질 수 있음
- 만약 `@TestExecutionListeners`로 기본 리스너를 대체하면, 트랜잭션, SQL 스크립트, 의존성 주입 등 테스트에서 기본적으로 기대되는 기능이 사라질 수 있으므로 주의해야 함

<hr>

##  예시

```java
@SpringJUnitConfig(MyConfig.class)
@TestExecutionListeners(
    listeners = MyCustomTestExecutionListener.class,
    mergeMode = TestExecutionListeners.MergeMode.MERGE_WITH_DEFAULTS
)
public class MyServiceTest {
   @Autowired
   private MyService myService;

   @Test
   void testSomething() {
       // MyCustomTestExecutionListener가 기본 리스너들과 같이 동작함
   }
}
```

- 기본 DI, 트랜잭션, SQL 스크립트, 웹 mock 등 Spring이 제공하는 기본 테스트 지원 유지
- 추가 커스텀 리스너(`MyCustomTestExecutionListener`)가 테스트 생명주기에 개입 가능

<hr>

## 언제/왜 TestExecutionListener 구성 바꾸는지

- 특정 테스트에 대해 트랙잭션 롤백을 하지 않고 커밋하거나, 또는 SQL 스크립트 실행 없이 테스트하고 싶을 때
- 테스트 실행 흐름에 커스텀 로깅, 매트릭 수집, 커스텀 초기화/정리 로직을 삽입하고 싶을 때
- 기본 `WebApplicationContext` 초기화 대신 특별한 ServletContext 구성이나 mock 설정이 필요할 때
- 기본 리스너 집합이 제공하는 기능이 과도하거나 불필요한 경우 