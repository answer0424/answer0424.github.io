---
layout: post
title: TestExecutionListener Configuration
date: 2025-12-01 09:00:00 +09:00
categories: [Spring, Testing, TestContext Framework, Context Management]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## 기본 개념 & 역할

- TestExecutionListener는 테스트 실행 시점에 훅을 걸어, 의존성 주입, 트랜잭션 설정, SQL 스크립트 실행, 컨텍스트 초기화/정리 등 여러 작업을 자동으로 처리하는 구성요소
- TestContext Framework는 기본적으로 여러 TestExecutionListener 구현들을 자동으로 등록해 두고 있으며 - 우리가 따로 설정하지 않아도 대부분의 테스트에서 필요한 기능이 동작함

<hr>

## 기본 등록되는 TestExecutionListener 들

| 리스너 이름 | 주요 역할 |
|-|-|
| `ServletTestExecutionListener` | Web 어플리케이션 테스트 시 서블릿 API용 mock 객체 설정, WebApplicationContext 테스트 지원 |
| `DirtiesContextBeforeModesTestExecutionListener` | `@DirtiesContext` 어노테이션이 붙은 경우, before 모드 처리 - 테스트 전에 컨텍스트 더럽힘 표시 |
| `ApplicationEventsTestExecutionListener` | 테스트 중에 `ApplicationContext`에서 발생하는 이벤트 지원 |
| `BeanOverrideTestExecutionListener` | 테스트 빈 오버라이딩을 허용하거나 관리하는 기능 제공 |
| `DependencyInjectionTestExecutionListener` | 테스트 인스턴스에 `@Autowired`, `@Value, `@Inject` 등을 사용한 의존성 주입 지원 |
| `MicrometerObservationRegistryTestExecutionListener` | 만약 Micrometer 관측 기능을 테스트에 포함했다면, 관측 레지스트리 설정 지원 |
| `DirtiesContextTestExecutionListener` | `@DirtiesContext` 어노테이션이 붙은 경우, after 모드 처리 - 테스트 후에 컨텍스트 더럽힘 표시 |
| `CommonCachesTestExecutionListener` | 리소스/캐시 캐시된 항목들을 정리 - 캐스 관련 리소스 누구 방지 등에 사용됨 |
| `TransactionalTestExecutionListener` | 테스트 메서드 실행 시 트랜잭션을 시작하고, 기본적으로 롤백 - DB를 테스트 이전 상태로 유지 |
| `SqlScriptsTestExecutionListener` | `@Sql` 어노테이션으로 지정된 SQL 스크립트들을 테스트 전/후 실행
| `EventPublishingTestExecutionListener` | 테스트 실행 생명주기 이벤트를 Spring `ApplicationContext`에 게시하여, 이벤트 리스너가 이를 구독 가능하게 함 | 
| `MockitoResetTestExecutionListener` | `@MockBean`, `@MockitoBean` 등을 사용해 생성된 mock/spy bean을 테스트 후 리셋하는 기능 제공 |

>  즉, 기본 등록된 리스너들만으로도 대부분의 통합 테스트 환경을 자동으로 지원받을 수 있음

<hr>

## 커스터마이징 - 커스텀 리스너 추가 또는 기본 리스너 재정의

#### `TestExecutionListeners` 어노테이션 사용

- 만약 기본 리스너 외에 커스텀 리스너를 추가학더나, 기본 리스너 구성을 변경하고 싶다면 테스트 클래스에 `@TestExecutionListeners` 어노테이션을 사용해서 명시할 수 있음

```java
@TestExecutionListeners(
    listeners = MyCustomTestExecutionListener.class,
    mergeMode = testExecutionListeners.MergeMode.MERGE_WITH_DEFAULTS
)
public class MyTest {...}
```

- 위처럼 `mergeMode = MERGE_WITH_DEFAULTS`를 지정하면, 커스텀 리스너 + 기본 리스너를 합친 뒤 중복 제거, 정렬된 상태로 적용됨
- 만약 `listeners`만 지정하고 `inheriListeners = false` 같이 설정하면, 기본 리스너들이 제거되므로 주의해야 함

<br>

#### 자동등록 / spring.factories 활용

- `spring-test` 모듈은 기본 리스너들을 `META-INF/spring.factories`를 통해 자동으로 등록함. 즉, 프로젝트나 타사 라이브러리에서 커스텀 TestExecutionListener를 전역으로 적용하고 싶다면 동일한 방식으로 `spring.factories`에 등록하면 됨
- 이렇게 하면 테스트 클래스마다 일일이 어노테이션 지정할 필요 없이, 자동으로 해당 리스너들이 활성화됨

<hr>

## 주의할 점

- 만약 `@TestExecutionListeners`를 사용해 커스텀 리스너를 등록하면서, mergeMode를 제대로 설정하지 않으면 기본 리스너들이 빠져서 DI, 트랜잭션, SQL 스크립트 처리 등 기본 기능이 동작하지 않을 수 있음
- 리스너의 순서(order)가 중요할 수 있음 , Spring은 리스너를 정렬하기 위해 `Ordered`인터페이스나 `@Order` 어노테이션을 사용하므로, 커스텀 리스너를 만들 경우 순서를 고려해야 함
- TestContext 캐싱이 적용되기 때문에, 만약 테스트에서 컨텍스트 상태를 변경하는 경우 이전/다음 테스트에 영향을 줄 수 있음