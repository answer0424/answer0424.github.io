---
layout: post
title: Application events
date: 2025-12-01 09:00:00 +09:00
categories: [Spring, Testing, TestContext Framework, Context Management]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## 개념 &목적 

- TestContext Framework는 테스트 실행 중에 ApplicationEvent를 기록해서 테스트 코드에서 이 이벤트가 발생했는가를 검증할 수 있게 지원함
- 즉, 서비스 로직이 특정 이벤트를 publish할 경우 ➡️ 테스트에서는 그 이벤트의 발생 여부, 횟수, 순서, 페이로드 등을 `ApplicationEvents` API를 통해 확인 가능
- 이 기능을 사용하면 단순한 리턴 값 검증이나 상태 변화 검증을 넘어서 이벤트 중심 설계의 동작을 테스트할 수 있어서 특히 이벤트/비동기 구조를 가진 어플리케이션에서 유용

<hr>

## 사용 방법

1. 테스트 클래스에 `@RecordApplicationEvents` 어노테이션을 추가
2. 이벤트 기록을 지원하는 리스너인 `ApplicationEventsTestExecutionListener`가 등록되어야 함
3. 테스트 메서드에서 매개변수로 `ApplicationEvents`를 선언하거나 테스트 클래스 필드에 `@Autowired ApplicationEvents events;`로 주입받음
4. 그런 뒤, 테스트 로직을 실행하고 `events.stream()` 또는 기타 `ApplicationEvents` API를 이용해 이벤트 발생 여부를 검증

```java
@SpringJUnitConfig
@RecordApplicationEvents
class MyServiceTests {
    @Autowired
    MyService myService;

    @Test
    void submitOrder_emitsOrderCreatedEvent(ApplicationEvents events) {
        myService.submitOrder(new Order(...));

        boolean emitted = events.stream(OrderSubmittedEvent.class)
                                .findFirst()
                                .isPresent();
        assertTrue(emitted);
    }
}
```

<hr>

## 유의사항 & 한계

- `@RecordApplicationEvents`가 지원하는 이벤트 기록은 동일 스레드에서 발생한 이벤트만 기록됨
  - 만약 이벤트 발행이 비동기 스레드에서 이뤄진다면, 이벤트가 기록되지 않을 수 있음
- `ApplicationEvents` 인스턴스는 테스트 메서드별 스코프이기 때문에, 클래스 레벨 생성자 주입으로는 사용할 수 없음
- 만약 테스트에서 사용 중인 `@TestExecutionListeners` 설정이 기본 리스너 배열을 덮어쓴다면 - `ApplicationEventsTestExecutionListener`가 누락될 수 있어서 이벤트 기록이 동작하지 않을 수 있음