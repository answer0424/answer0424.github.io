---
layout: post
title: Context Configuration with Environment Profiles
date: 2025-12-02 09:00:00 +09:00
categories: [Spring, Testing, TestContext Framework, Context Management]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## 개념

- Spring은 환경 개념을 지원하며, 서로 다른 환경/목적에 따라 빈, 설정, 데이터소스 등을 바꿔가며 구성할 수 있음
- 테스트 시에도 이 설정을 활용할 수 있도록, TestContext Framework는 @ActiveProfiles 어노테이션을 제공
- 즉, 테스트용 컨텍스트 로딩 시점에 profile 정보를 반영해서 profile-specific 빈 정의나 설정이 적용된 상태로 `ApplicationContext`를 구성할 수 있음

<hr>

## 사용 방법

#### @ActiveProfiles 사용 예

```java
@ExtendWith(SpringExtension.class)
@ContextConfiguration("/app-config.xml")
@ActiveProfiles("dev")
public class TransferServiceTest {
    // 테스트 코드…
}
```

- 위 예에서, `app-config.xml` 안에 여러 profile 별로 다른 빈 정의가 있을 수 있음
- 테스트에 `@ActiveProfiles("dev")`를 붙이면, dev profile에 속한 빈 정의가 활성화되고, 그에 따라 테스트용 데이터 소스나 mock bean 등 dev 환경 설정이 반영됨

<br>

#### 여러 profile 한번에 지정

```java
@ActiveProfiles({"dev", "integration"})
```

<br>

#### 기본 프로필

- 만약 아무 profile도 활성화하지 않으면, default profile에 속한 빈/설정이 로드됨
- 즉, default profile은 명시된 profile이 없을 때 fallback 역할을 함

<hr>

## 테스트에서 Profile 설정을 쓰는 이유

- 환경마다 다른 설정이 필요할 때
  - 예: 개발용 DB, 테스트용 인메모리 DB, 운영용 JNDI DB 등 - profile 별로 분리된 설정을 정의하고, 테스트마다 적절한 profile을 활성화하면 편리
- 테스트 격리 + 설정 재사용
  - 공통 빈 정의는 유지하면서, profile 별로 데이터 소스나 외부 연동 설정만 바꾸고 싶을 때
- 동일 코드 베이스에서 다양한 환경 테스트
  - dev 환경, test 환경, prod 환경을 동일 코드로 지원하면서, 각 환경에 맞는 빈 구성을 테스트 통해 보장하고 싶을 때
- 설정 관리 단순화
  - profile을 통해 설정을 분리해두면, production 설정과 test 설정을 한 곳에서 관리하면서도 혼동을 줄일 수 있음

<hr>

## 주의사항

- `@ActiveProfiles`는 TestContext에서만 적용되는 profile 설정 방식이고, 전통적인 JVM 시스템 프로퍼티나 external property-based 프로필 설정 방식과는 다소 다르게 동작
- 만약 profile-based 설정이 복잡하다면, profile 간 빈 충돌, 설정 불일치 위험이 있음
- 여러 테스트 클래스에서 동일 profile 설정을 반복하면, 코드 중복될 수 있음 - base 테스트 클래스 + subclass + 프로필 상속 구조를 잘 설계하는 게 좋음

<hr>

## 예시

```xml
<beans>
  <beans profile="dev">
    <jdbc:embedded-database id="dataSource">
      <!-- schema.sql + test-data.sql 등 -->
    </jdbc:embedded-database>
  </beans>

  <beans profile="production">
    <jee:jndi-lookup id="dataSource" jndi-name="java:comp/env/jdbc/datasource"/>
  </beans>

  <beans profile="default">
    <jdbc:embedded-database id="dataSource">
      <!-- minimal default DB 설정 -->
    </jdbc:embedded-database>
  </beans>

  <bean id="accountRepository" class="com.bank.repository.JdbcAccountRepository">
    <constructor-arg ref="dataSource"/>
  </bean>
  <bean id="transferService" class="com.bank.service.DefaultTransferService">
    <constructor-arg ref="accountRepository"/>
  </bean>
</beans>
```

#### 테스트 코드

```java
@ExtendWith(SpringExtension.class)
@ContextConfiguration("/app-config.xml")
@ActiveProfiles("dev")
public class TransferServiceTest {

    @Autowired
    TransferService transferService;

    @Test
    void testTransfer() {
        // dev 환경 (embedded DB + test data) 로 동작
    }
}
```

> 위처럼 하면, 테스트는 dev profile에 맞춘 embedded DB 환경 + repository + service 구성으로 실행됨