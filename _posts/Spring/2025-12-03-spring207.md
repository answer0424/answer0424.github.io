---
layout: post
title: Context Caching
date: 2025-12-03 09:00:00 +09:00
categories: [Spring, Testing, TestContext Framework, Context Management]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## 존재 이유

- 스프링 어플리케이션에서 `ApplicationContext`가 커다란 비용이 될 수 있음
- 그래서 TestContext Framework는 한번 로드된 `ApplicationContext`를 static 캐시에 보관하고, 동일한 설정이 요구되는 이후 테스트에서 해당 cached context를 재사용하도록 설계되어 있음
- 이 캐싱 덕분에, 전체 테스트 수가 많아져도 context 초기화 비용을 반복하지 않아서, 테스트 실행 속도가 크게 단축될 수 있음 

<hr>

## 캐시 재사용 기준

| 항목 | 의미 |
|-|-|
| `locations` | `@ContextConfiguration(locations=...)`에 지정된 XML / 리소스 경로들 |
| `classes` | `@ContextConfiguration(classes=...)`에 지정된 자바 설정 클래스들 |
| `contextInitializerClasses` | `@ContextConfiguration(initializers=...)`에 지정된 context 초기화 |
| `contextCustomizers` | `ContextCustomizerFactory` 등이 제공하는 커스터마이저 |
| `contextLoader` | 어떤 컨텍스트 계층 |
| `parent` | 부모 컨텍스트 계층 |
| `activeProfiles` | `@ActiveProfiles`로 활성화된 프로파일 목록 |
| `propertySourceDesctiptors` / `propertySourceProperties` | `@TestPropertySource` 또는 프로퍼티 소스 추가 설정 |
| `resourceBasePath` | 웹 설정에서 `@WebAppConfiguration` 등으로 지정된 리소스 기본 경로 |

<hr>

## 캐시 동작 방식 & 제약

- 캐시는 static 변수로 관리되며, 같은 JVM에 만 공유됨
- 캐시의 기본 최대 크기는 32개로 제한되어 있고, LRU 방식으로 오래된 context는 제거됨
- Spring 7.0 이후부터는 cached context가 비활성화 상태로 전환되었다가 재사용 시 다시 시작됨
  - 즉, 백그라운드에서 scheduler, JMS listener, SmartLifecycle 빈 등은 context가 비활성일 때 중지되도 재사용 시 다시 시작됨
- 만약 어떤 테스트가 context 내부 상태를 변경했다면 - 그 변경이 다른 테스트에 영향을 줄 수 있으므로 테스트에 `@DirtiesContext`를 사용해 이 컨텍스트 더 이상 재사용하지 않겠다라고 표시할 수 있음 

<hr>

## 장점

- 테스트 속도 대폭 향상 - 복잡한 Spring 설정 + 빈 초기화가 많은 경우에도 한 번만 로딩 ➡️ 이후 테스트는 빠르게 실행됨
- 리소스 절약 - 컨테이너 재생성 비용, 메모리/스레드/커넥션 풀 초기화 비용 절감
- 여러 테스트 클래스 간 설정 공유 가능 - 공통 config가 많다면 테스트마다 중복 선언 없이 재사용
- 개발 편의성 / CI 효율 증가 - 전체 테스트 스위트 시간이 줄어들어 빠른 피드백 가능 ➡️ 개발 속도, 안정성 향상

<hr>

## 주의할 점

- 설정 미세 변경 ➡️ 새 context 생성 ➡️ 작은 프로파일 변경, `@MockMvc` 추가, 프로퍼티 변경 등이 캐시 key를 바꿔서 context 재생성을 유발할 수 있음
- 테스트 간 남아 있을 경우, 테스트 간 간섭이 발생할 수 있음
- 리소스 누수 및 예상치 못한 동작 - Spring 7.0 이전엔 cached context가 닫히지 않고 유지되어, JMS listener, 리스너, 스케줄 등 백그라운드가 계속 동작할 수 있었음
- 테스트 격리성이 낮아질 수 있음  - 이상적으로 테스트는 동립적이어야 하는데, 캐싱 + 공유 컨텍스트는 이 원칙을 깨뜨릴 가능성이 있음 