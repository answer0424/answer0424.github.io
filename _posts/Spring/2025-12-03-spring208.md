---
layout: post
title: Context Hierarchies
date: 2025-12-03 09:00:00 +09:00
categories: [Spring, Testing, TestContext Framework, Context Management]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## 개념 

- 보통은 테스트를 위해 하나의 `ApplicationContext`만 로드하면 충분하지만, 경우에 따라 부모-자식 구조의 여러 Context를 함께 구성해야 할 때가 있음
- 전형적인 예는 웹 어플리케이션
  - 루트 컨텍스트 - 공통 인프라, 서비스 계층, DAO, 공통 빈 등 
  - 서블릿 전용 컨텍스트 - 컨트롤러, 뷰 리졸버, 핸들러 매핑 등 웹-계층 빈들 
- 다른 예: 배치 작업 또는 복잡한 모듈 구성 - 부모 컨텍스트에 공통 구성, 자식 컨텍스트에 Job / 모듈 - specific 설정 분리

<hr>

## 설정 방법 - `@ContextHierarchy` 사용

```java
@ExtendWith(SpringExtension.class)
@WebAppConfiguration
@ContextHierarchy({
    @ContextConfiguration(classes = TestAppConfig.class),  // root context
    @ContextConfiguration(classes = WebConfig.class)       // servlet / web context (child)
})
class ControllerIntegrationTests {

    @Autowired
    WebApplicationContext wac;  // child context가 주입됨

    // 테스트 메서드들 ...
}
```

- 위 예에서는 `TestAppConfig`(root) + `WebConfig`(child)를 계층으로 구성
- 테스트 클래스에서 `@Autowired WebApplicationContext`로 주입받는 컨텍스트는 child임

<hr>

## 클래스 상속 + 계층 구성 조합도 가능

- 만약 테스트 클래스가 상속 구조라면 부모,자식 클래스 각각에 `@ContextHierarchy`를 선언해도 되고 자식에서 부모 설정을 이어받거나 덮어쓰는 방식으로 구성할 수 있음
- 이렇게 하면, 공통 설정을 부모 또는 상위에 두고, 테스트마다 필요한 child 설정만 자식 클래스에서 정의하는 방식으로 설정의 중복을 줄일 수 있음 

<hr>

## 주의점 & 한계

- 설정 타입 일관성 필요: 같은 계층 내에서는 설정 방식을 섞지 않는 것이 권장
- 상속 + 계층 + 프로필/캐싱/커스터마이징 혼합 주의: 여러 축의 얽히면 어떤 설정이 최종적으로 적용되는지 추적이 어려울 수 있음
- 캐시 & 상태 공유 주의: 계층 구조 컨텍스트도 캐싱 대상이기 때문에, child 혹은 root context에서 mutable 빈이나 싱글톤 빈, 리소스 등을 사용한다면 테스트 간 간섭이 발생할 수 있음
- 복잡성 증가:  단순 테스트에는 오히려 설정 복잡도가 높아질 수 있음 - 계층 구조를 남용하면 설정 가독성/유지보수가 떨어질 수 있음 