---
layout: post
title: Transaction Management
date: 2025-12-04 09:00:00 +09:00
categories: [Spring, Testing, TestContext Framework]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## 개요

- TestContext Framework에서는 테스트 실행 시 트랜잭션 관리를 자동으로 지원함
- 다만 테스트에서 트랜잭션을 사용하려면, 로드되는 `ApplicationContext` 안에 반드시 `PlatformTransactionManager` 빈이 설정되어 있어야 함
- 트랜잭션은 test-managed transaction이라고 불리는 별도 카테고리로, 일반 어플리케이션 코드 내에서 수동으로 관리하는 트랜잭션과는 구분됨

<hr>

## 사용 방법 - 설정 + 어노테이션 + 동작 흐름

#### 기본 사용

- 테스트 클래스 또는 메서드에 `@Transactional` 을 붙이면 됨

```java
@SpringJUnitConfig(MyTestConfig.class)
@Transactional  // 클래스 레벨 → 모든 테스트 메서드에 트랜잭션 적용
public class MyRepositoryTests {
    @Autowired MyRepository repo;

    @Test
    void testSomething() {
        // repo.save(...), repo.find... 등
        // 테스트가 끝나면 자동 롤백
    }
}
```

- 또는 메서드 단위로 붙여도 되고, `@Transactional`이 없는 메서드는 트랜잭션 없이 실행됨
- 트랜잭션 속성도 일부 지원됨: `value`, `propagation` - 다만 test-managed 트랜잭션에서는 `propagation = REQUIRED` 또는 `SUPPORTS`만 정상 지원되고 `NOT_SUPPORTED`, `NEVER`는 예외없이 transaction없이 실행됨

<br>

#### TestTransactional - 프로그래밍 방식 제어

- 기본은 테스트 끝나면 자동 롤백이지만, 경우에 따라 커밋 / 롤백을 수동 제어할 수도 있음
- 이를 위해 제공되는 유틸리티가 TestTransaction

```java
@Test
@Transactional
void testWithManualCommit() {
    // … some DB operations
    TestTransaction.flagForCommit();  // 이 테스트는 롤백이 아니라 커밋
}
```

- 또는 기본 롤백을 유지하되, 중간에 상태를 확인하거나 조건에 따라 롤백/커밋 결정 가능

<hr>

## 장점

- 테스트 격리 보장: 각 테스트 메서드가 독립된 트랜잭션에서 실행되고, 기본적으로 롤백되므로 테스트마다 DB 상태를 깨끗하게 유지 가능
- 통합 테스트 용이: repository + service + DB 연동을 포함한 통합 테스트를 쉽게 작성 가능
- 설정 간소화: 별도로 cleanup 코드를 작성할 필요 없음 - 트랜잭션 + 롤백이 자동으로 동작 

<hr>

## 유의사항

- `@Transactional`은 테스트 메서드에만 적용
  - `@BeforeAll`, `@BeforeClass`, `@BeforeAll` 같은 클래스/스위트 레벨 메서드에는 적용되지 않음. 만약 전처리/후처리 단계에서도 트랜잭션이 필요하다면, 직접 `PlatformTransactionManager` + `TransactionTemplate` 또는 `TestTransaction`을 사용해야 함
- transaction 속성 일부 제한: isolation, timeout, readOnly, rollbackFor 등은 지원되지 않음
  - 따라서 복잡한 트랜잭션 시나리오는 TestContext 트랜잭션으로는 구현 불가
- 테스트 프레임워크의 `preemptive timeout`과 함께 쓰면 주의가 필요함
- 테스트 내에서 서비스 코드가 더 내부적으로 또 다른 트랜잭션을 열면, 트랜잭션 경계가 복잡해질 수 있고, TestContext 트랜잭션과의 상호작용에서 주의 필요