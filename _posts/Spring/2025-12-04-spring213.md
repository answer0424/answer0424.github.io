---
layout: post
title: Executing SQL Scripts
date: 2025-12-04 09:00:00 +09:00
categories: [Spring, Testing, TestContext Framework]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## 필요 이유

- 통합 테스트에서 실제 데이터베이스 스키마 생성, 초기 데이터 삽입, 테스트별 DB 상태 초기화 등이 필요할 때가 많음
- 매번 DAO/Repository 레이어 호출로 테스트 데이터를 세팅하거나 지우는 것보다, SQL 스크립트를 통해 테이블 생성 + 초기 데이터 삽입 + cleanup을 자동화하면 훨씬 편리하소 명확
- Spring은 이런 필요를 위해, 테스트 컨텍스트 로딩 시 또는 테스트 실행 중에 SQL 스크립트를 자동 또는 수동으로 실행할 수 있는 메커니즘을 제공

<hr>

## 지원방식: 프로그래밍 방식 vs 선언 방식


#### 프로그래밍 방식

- `org.springframework.jdbc.datasource.init.ResourceDatabasePopulator`
- `org.springframework.jdbc.datasource.init.ScriptUtils`
- (JUnit 4 / TestNG 사용 시) `AbstractTransactionalJUnit4SpringContextTests`, `AbstractTransactionalTestNGSpringContextTests` 등의 편의 메서드

<br>

#### 예시

```java
@Test
void databaseTest() {
    ResourceDatabasePopulator pop = new ResourceDatabasePopulator();
    pop.addScripts(
        new ClassPathResource("test-schema.sql"),
        new ClassPathResource("test-data.sql")
    );
    pop.setSeparator(";;");  // (예: 커스텀 구분자 사용 시)
    pop.execute(dataSource);

    // 이후 테스트 로직 실행
}
```


<hr>

## 선언 방식 - `@Sql` 사용

- `@Sql`은 클래스 레벨 또는 메서드 레벨에 붙일 수 있고, 여러 SQL 리소스 파일을 지정할 수 있음
- 기본적으로 `BEFORE_TEST_METHOD` 시점에 실행되지만, `executionPhase` 속성으로 `AFTER_TEST_METHOD` 또는 다른 시점을 지정할 수 있음
- 경로 지정 방식:
    - `"schema.sql"` 처럼 단순 경로 → 테스트 클래스의 패키지를 기준으로한 상대 클래스패스 리소스
    - `"/db/schema.sql"` 처럼 슬래시(`/`)로 시작 → 프로젝트 클래스패스 루트 기준 절대 클래스패스 리소스
    - `"classpath:..."`, `"file:..."` 등 URL 접두사 사용 가능 
- 또한, Spring 6.2 이상에서는 리소스 경로에 프로퍼티 플레이스홀더(`${…}`)를 사용할 수 있어 — 테스트 환경의 프로퍼티에 따라 동적으로 SQL 파일 위치를 바꾸는 것도 가능


```java
@SpringJUnitConfig(AppConfig.class)
@Sql("/test-schema.sql")  // 클래스 전체 테스트 전에 스키마 초기화
public class MyRepositoryTests {

    @Test
    @Sql({ "/test-schema.sql", "/test-data-user.sql" })
    void testFindUser() {
        // 이 테스트 메서드 전용으로 schema + user 데이터 삽입됨
        // Repository 조회 테스트
    }
}
```