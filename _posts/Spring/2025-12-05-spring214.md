---
layout: post
title: Parallel Test Execution
date: 2025-12-04 09:00:00 +09:00
categories: [Spring, Testing, TestContext Framework]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## 개념

- Spring TestContext Framework는 단일 JVM 내에서 여러 테스트 클래스 혹은 테스트 메서드의 병렬 실행을 기본적으로 지원
- 구체적으로 대부분의 테스트 클래스나 메서드들을 병렬로 실행할 수 있으며, 이는 테스트 속도 개선, 전체 테스트 스위트 실행 시간 단축에 유리
- 내부적으로는 Spring 쪽 `TestContext` 구현체가 복사 가능한 `TestContext`를 제공해야 하고 기본 제공되는 `DefaultTestContext`는 copy-constructor를 제공하여 병렬 실행이 가능

<hr>

## 사용 시기

- 실제 병렬 실행은 Spring이 아닌 테스트 러너/빌드 도구/IDE 설정을 통해 활성화해야 함
  - JUnit 5 + `JUnit Platform`의 병렬 실행 설정 
  - Gradle, Maven 또는 IDE에서 병렬 테스트 실행 활성화
- Spring 쪽에서는 추가 설정 없이도 동작하지만, 다음 조건/제약을 준수해야 함

<hr>

## 주의 사항

- `@DirtiesContext`를 사용하는 테스트 - 이 어노테이션은 테스트 이후 컨텍스트를 더럽힌 것으로 표시하고 캐시에서 제거시키는데, 병렬로 다른 테스트가 같은 컨텍스트를 쓰려다가 충돌이 생길 수 있음
- `@MockitoBean` / `@MockitoSpyBean` 또는 Spring Boot의 `@MockBean` / `@SpyBean`을 사용하는 테스트 - mock/spy 기반 빈 오버라이드는 테스트 컨텍스트 캐싱 및 공유 흐름과 충돌할 가능성이 있음
- `@TestMethodOrder` 등 테스트 메서드 순서 보장 기능을 사용하는 경우 - 메서드 간 순서 의존성이 있다면 병렬 실행은 적합하지 않음
- DB, 메시지 브로커, 파일 시스템, 외부 리소스 등 공유 상태가 있는 리소스를 사용하는 경우 - 여러 테스트가 병렬로 동시에 동일 리소스를 조작하면 간섭 발생

<hr>

## 병렬 실행 + Context 캐싱 ➡️ 테스트 속도 & 효율 향상

- 병렬로 여러 테스트를 동시에 실행하면, 테스트 전체 시간을 단축할 수 있음 - 특히 테스트 스위트가 크고 많은 통합 테스트가 있을 때 효과적
- Spring TestContext Framework의 context caching과 함께 쓰면 컨텍스트 로딩 비용 + 테스트 실행이 병렬 + reuse 조합으로 크게 줄어들 수 있음
- 실제로 커뮤니티에서도 JUnit 5 병렬 실행 + Spring TestContext 캐시 함께 사용 가능하다는 피드백이 많음

<hr>

## 정리

- 적합한 경우: 순수 서비스/비즈니스 로직 테스트, 독립적인 통합 테스트, 공유 상태가 없는/독립 리소스를 사용하는 테스트, mock 없이 단순 bean + DB + context 재사용 가능한 테스트
- 피하거나 분리해야 할 경우: mock/spy bean override 사용하는 테스트, `@DirtiesContext` 사용하는 테스트, 외부 리소스나 공유 상태에 의존하는 테스트, 메서드 간 순서 의존 있는 테스트