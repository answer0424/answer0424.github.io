---
layout: post
title: WebTestClient
date: 2025-12-05 09:00:00 +09:00
categories: [Spring, Testing, TestContext Framework]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## 개요

- WebTestClient는 HTTP 요청을 보내고 응답을 검증할 수 있는 테스트 전용 HTTP 클라이언트
- 특징
  - 실제 서버 없이도 테스트 가능 - mock request/response 환경에서 동작
  - 실제 서버가 있는 상태에서도 엔드-투-엔드 테스트 가능 - 통합 테스트용 HTTP 호출 클라이언트로 활용
  - WebFlux 기반뿐 아니라, Spring MVC 환경에서도 사용 가능 - WebFlux가 아니어도 REST API 테스트에 사용하기 좋음

> 즉, WebTestClient는 서버 + 컨트롤러 + 핸들러 체인 + 직렬화/역직렬화 + HTTP layer 전체를 포함한 테스트를 가능하게 해주는 도구

<hr>

## 주요 방식

| 방식 | 언제/어떻게 사용 | 특징 |
|-|-|-|
| bindToController | 특정 컨틀롤러만 테스트할 때 | 해당 컨트롤러만 mock request/response 환경에서 호출 가능 |
| bindToApplicationContext | Spring 설정 전체 + MVC or WebFlux 환경 + 모든 컨트롤러 포함 테스트 | ApplicationContext를 통해 bean config를 로드하고, 실제처럼 handler chain 구성 |
| bindToRouterFunction | functional routing 기반 WebFlux 어플리케이션 테스트할 때 | WenFlux의 router  + handler function 기반 REST API를 테스트할 때 적합 |
| bindToServer | 실제 서버가 실행 중이거나 외부 서버 대상 테스트 시 | baseUrl 지정하고, HTTP over network 요청을 보내 통합 테스트 또는 E2E 테스트 가능 |

<hr>

## 예제

```java
@SpringJUnitConfig(WebConfig.class)  // Spring 설정 클래스
class MyControllerTest {

    WebTestClient client;

    @BeforeEach
    void setUp(ApplicationContext context) {
        client = WebTestClient.bindToApplicationContext(context).build();
    }

    @Test
    void testGetHello() {
        client.get().uri("/hello")
              .exchange()
              .expectStatus().isOk()
              .expectBody()
              .jsonPath("$.message").isEqualTo("Hello");
    }
}
```

- 위 예제는 실제 서버 없이 Spring 설정 + 컨텍스트만으로 컨트롤러 호출 + 응답 검증을 수행하는 통합 테스트
- 요청 메서드, URI, 헤더, 바디 설정이 가능하며, 응답 상태, 헤더, body도 검증 가능

<hr>

## WebTestClient의 장점

- 서버 없이도 테스트 가능: mock 환경 + Spring Context 만으로 endpoint 테스트 가능 - 테스트 속도 빠르고 독립적
- 비동기 / reactive / blocking 모두 지원: WebClient 기반이라 reactive API 테스트에 특히 적합하지만, blocking 방식 REST API도 잘 처리됨
- 통합 테스트 + E2E 테스트 유연: 서버 binding, context binding 또는 실제 서버 호출 등 다양한 방식 지원
- 공식 스프링 테스트 인프라와 호환성: JSON 직렬화, WebFlux, Web MVC, RouterFunction, Spring Security 연동 테스트 등 기존 스프링 설정과 자연스럽게 통합됨

<hr>

## 주의사항

- mock 기반 테스트이기 때문에, 실제 WAS 환경 고유의 동작은 테스트되지 않음
- WebFlux와 Spring MVC가 함께 있을 경우, 사용 전 `spring.main.web-application-type` 등을 적절히 설정해야 충돌이 없다는 경험담이 있음
- 일부 보안/인증 설정과 함께 사용 시 설정이 복잡해질 수 있으며, 인증 필터/설정이 제대로 적용됐는지 주의해야 함