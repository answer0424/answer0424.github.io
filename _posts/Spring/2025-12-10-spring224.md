---
layout: post
title: Defining Expectations
date: 2025-12-10 09:00:00 +09:00
categories: [Spring, Testing, TestContext Framework, MockMvc, Hamcrest]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## 개요

- MockMvc로 요청을 보낸 후, 응답 또는 처리 결과에 대해 기대하는 조건을 정의하고 검증하는 방법을 설명
- 즉, 테스트 흐름이 요청 보내기 ➡️ 응답 또는 처리결과 ➡️ 검증으로 이어지도록 해주는 기능

<hr>

## 기본 사용법: `andExpect()` / `andExpectAll()`

#### `andExpect()` 메서드

- 요청 후 `.andExpect()`를 하나 붙이면 그 조건을 검증

```java
mockMvc.perform(get("/account/1"))
        .andExpect(status().isOk())
```

<br>

#### `andExpectAll()` 메서드 

- 여러 기대 조선들을 한번에 넘기고 모두 검증하고 싶다면 `.andExpectAll()`을 사용
- 이 경우에 supplied한 모든 expectations가 적용되고 실패한 것들을 모두 보고됨

```java
mockMvc.perform(get("/account/1"))
        .andExpectAll(
            status().isOk(),
            content().contentType("application/json; charset=UTF-8")
        )
```


<hr>

## 검증 가능한 항목들

#### 응답 속성 기반 검증

- HTTP 응답 상태
- 응답 헤더
- 응답 본문 - 텍스트, JSON, XML 등

> 특히 JSON 응답의 경우, `jsonPath()` + 값 비교로 특정 필드 또는 구조를 검사할 수 있고, XML 응답은 `xpath()`로 검증 가능

```java
mockMvc.perform(get("/people").accept(MediaType.APPLICATION_JSON))
       .andExpect(jsonPath("$.links[?(@.rel == 'self')].href")
           .value("http://localhost:8080/people"));
```

```java
mockMvc.perform(get("/handle").accept(MediaType.APPLICATION_XML))
       .andExpect(xpath("/person/ns:link[@rel='self']/@href", ns)
           .string("http://localhost:8080/people"));
```

<br>

#### Spring MVC / Servlet-specific 처리 결과 검증

- 어떤 컨트롤러 메서드가 요청을 처리했는지
- 예외가 발생했는지, 또는 특정 예외가 처리됐는지
- 모델 속성: 모델에 어떤 attribute가 추가되었는지, validation/binding 에러가 있는지 등
- 뷰가 선택되었는지, 어떤 뷰인지
- 세션 속성, 요청 속성, 플래시 속성 등 서블릿 컨텍스트 관련 속성들

```java
mockMvc.perform(post("/persons"))
       .andExpect(status().isOk())
       .andExpect(model().attributeHasErrors("person"));
```

<hr>

## 기타 유용한 기능들

#### 결과 출력: `.andDo(print())` / `.andDo(log())`

- 테스트 중에 요청 결과를 콘솔 또는 원하는 출력 스트림으로 출력하고 싶다면 `.andDo(print())` 또는 `.andDo(log())` 사용

```java
mockMvc.perform(post("/persons"))
       .andDo(print())
       .andExpect(status().isOk())
       .andExpect(model().attributeHasErrors("person"));
```

> 이 방법은 디버깅하거나, 테스트 중 어떤 응답이 왔는지 확인하고 싶을 때 유용

<br>

#### 원시 결과 직접 획득: `.andReturn()`

- 기대만으로는 검증하기 어려운 복잡한 조건이나 커스텀 로직 검증을 위해서는 `.andReturn()`을 사용해 `MvcResult` 객체를 받아올 수 있음
- 이렇게 하면, 응답 본문, 헤더, 세션, 모델, 요청 처리 정보 등 모든 결과를 직접 확인/분석할 수 있음

```java
MvcResult mvcResult = mockMvc.perform(post("/persons"))
                            .andExpect(status().isOk())
                            .andReturn();
```

<br>

#### 공통 Expectations 설정하기: `alwaysExpect()`

- 만약 테스트 케이스 여러 개에서 동일한 기대 조건이 반복된다면, MockMvc 인스턴스를 만들 때 공통을 미리 지정할 수 있음

```java
mockMvc = standaloneSetup(new SimpleController())
     .alwaysExpect(status().isOk())
     .alwaysExpect(content().contentType("application/json;charset=UTF-8"))
     .build();
```

- 한가지 주의: 이 expect 대상은 항상 적용되며, 특정 테스트에서 덮어쓰려면 별도 MockMvc 인스턴스를 만들어야 함

<hr>

## 언제 이 기능을 활용하는지

- HTTP API 응답 상태, 헤더, 본문 등을 정확히 검사하고 싶을 때
- 컨트롤러 내부에서 모델 바인딩, validation, view 결정, 플래스 속성, 예외 처리 등 Spring MVC-specific한 흐름이 올바른지 검증하고 싶을 떄
- 공통된 기대 조건이 많아서 테스트가 반복될 떄
- 단위 테스트 + 통합 테스트 중간 성격인 슬라이스 테스트에서, 전체 서버를 띄우지 않고도 컨트롤러 로직 + 응답 흐름을 테스트하고자 할 떄