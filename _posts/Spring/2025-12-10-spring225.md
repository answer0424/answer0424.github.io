---
layout: post
title: Async Requests
date: 2025-12-10 09:00:00 +09:00
categories: [Spring, Testing, TestContext Framework, MockMvc, Hamcrest]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## 개요

- Spring MVC는 Servlet 3.0 비동기 요청 처리를 지원함
- 즉, 요청 처리 중 원래 서블릿 쓰레드를 바로 반환하고 실제 응답은 다른 쓰레드에서 완료한 뒤 서블릿 컨테이너 쓰레드로 async dispatch 해서 응답을 마침
- `MockMvc` 만으로도 이 비동기 요청 처리 흐름을 시뮬레이션하고 테스트할 수 있음
  1. 요청을 perform 함
  2. 비동기 처리 시작됨 + 비동기 결과 등 초기 상태를 검사
  3. 반환된 결과(`MvcResult`)를 가지고 수동으로 async dispatch를 호출
  4. dispatch 후 최종 응답을 검증
- 만약 `MockMvc`를 통해서가 아니라 WebTestClient를 사용해 테스트한다면, 별도로 신경 쓸 필요 없음

<hr>

## Async 테스트의 기본 패턴

#### Java 예제

```java
// static import of MockMvcRequestBuilders.* and MockMvcResultMatchers.*

@Test
void test() throws Exception {
    MvcResult mvcResult = this.mockMvc.perform(get("/path"))
            .andExpect(status().isOk())               // (1) 초기 응답 상태 확인
            .andExpect(request().asyncStarted())       // (2) 비동기 처리 시작됨(assert)
            .andExpect(request().asyncResult("body"))  // (3) 비동기 결과 값 확인
            .andReturn();

    // (4) 수동으로 async dispatch 수행 — 테스트 환경에서는 실제 container가 없기 때문
    this.mockMvc.perform(asyncDispatch(mvcResult))
            .andExpect(status().isOk())               // (5) dispatch 후 최종 상태 검증
            .andExpect(content().string("body"));     // 응답 본문 검증
}
```

1. 요청이 정상적으로 초기 응답을 반환하는지 확인
2. 컨트롤러가 비동기 처리를 시작했음을 확인
3. 비동기 결과 - 즉, 실제 비동기 로직의 결과를 기대하고 맞는지 검사
4. 테스트 환경에서는 실제 서블릿 컨테이너가 없기 때문에, `asyncDispatch()`로 수동 dispatch
5. dispatch 후 최종 응답을 검증