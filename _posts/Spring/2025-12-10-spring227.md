---
layout: post
title: Performing Requests
date: 2025-12-10 09:00:00 +09:00
categories: [Spring, Testing, TestContext Framework, MockMvc, AssertJ]
tags: [spring]
image:
    path: /assets/img/spring/Spring.png
---

## 개요

- MockMvcTester를 이용해 요청을 구성하고 전송하는 방법을 설명
- 기존의 MockMvc + Hamcrest 방식과 달리 AssertJ 스타일의 fluent API를 사용하므로 정적 static import 없이도 요청 빌드 + 검증이 가능
- 즉, 요청 생성 ➡️ 실행 ➡️ 응답 / 결과 흐름을 AssertJ 기반으로 간결하고 직관적으로 작성 가능

<hr>

## MockMvcTester로 요청 수행하기

- `get()`, `post()`, `put()`, `delete()` 등 HTTP 메서드별 빌더 메서드를 사용해 요청을 생성

<hr>

## 요청 구성: URI/파라미터/멀티파드/컨텍스트 경로

- URI 템플릿 + Path 변수

```java
mockMvc.post().uri("/hotels/{id}", 42).accept(MediaType.APPLICATION_JSON)
```

- 쿼리 파라미터 via URI 템플릿

```java
mockMvc.get().uri("/hotels?thing={thing}", "somewhere")
```

- Servlet request parameter

```java
mockMvc.get().uri("/hotels").param("thing", "somewhere")
```

- 멀티파트 파일 업로드

```java
mockMvc.post().uri("/upload").multipart()
        .file("file1.txt", "Hello".getBytes(StandardCharsets.UTF_8))
        .file("file2.txt", "World".getBytes(StandardCharsets.UTF_8))
```

- 컨텍스 경로/서블릿 경로 포함 요청

```java
mockMvc.get().uri("/app/main/hotels/{id}", 42)
    .contextPath("/app")
    .servletPath("/main")
```

<hr>

## 요청 수행 + 응답 검증: `assertThat()`, `exchange()`, `async`

#### 간단한 요청 + 응답 검증

```java
assertThat(mockMvc.get().uri("/hi"))
    .hasStatusOk()
    .hasBodyTextEqualTo("Hello, World!")
```

<br>

#### 복잡한 경우: `exchange()`로 결과 받아서 여러 검증

```java
MvcTestResult result = mockMvc.post().uri("/save").exchange();
assertThat(result).hasStatus(HttpStatus.CREATED);
assertThat(result).body().isEmpty();
```

> `exchange()` 메서드는 요청을 실행하고 `MvcTestResult` 객체를 반환 ➡️ 이후 여러 `assertThat(result)` 호출로 다양한 검증 가능

<br>

## 비동기 요청 처리

- 만약 요청이 비동기 처리되는 경우 `exchange()`는 기본적으로 완료될 때가지 기다린 후 결과를 반환하므로, 추가 async-dispatch 코드를 작성할 필요 없음
- 필요한 경우, 타임아웃을 지정할 수도 있음

```java
assertThat(mockMvc.get().uri("/compute").exchange(Duration.ofSeconds(5)))
    . // ...
```

<hr>

## 기존 MockMvc(Hamcrest) 방식과의 차이/장점

| 항목 | MockMvc + Hamcrest | MockMvcTester + AssertJ |
|-|-|-|
| API 스타일 | static import + 매처 체인 | fluent API + `assertThat()` |
| 예외 처리 | perform/request 수행 시 Exception 발생 가능 ➡️ `throws Exception` 필요 | 예외를 직접 throw 하지 않고, `MvcTestResult` 통해 검증 가능 |
| 비동기 요청 | 별도 async-dispatch 코드 필요 | `exchange()`만으로 자동 완료 대기 / 처리 |
| 가독성 / 가독 + 유지보수 | Hamcrest matcher 구문이 복잡할 수 있음 | AssertJ + fluent API 덕분에 읽기/쓰기 더 직관적 |


<hr>

## 예제

```java
assertThat(mockMvc.get().uri("/hotels?thing={thing}", "somewhere"))
    .hasStatusOk()
    .hasBodyTextContaining("somewhere");

assertThat(mockMvc.post().uri("/upload").multipart()
        .file("file1.txt", "Hello".getBytes(StandardCharsets.UTF_8)))
    .hasStatusCreated();

MvcTestResult result = mockMvc.put().uri("/hotels/{id}", 42)
    .accept(MediaType.APPLICATION_JSON)
    .exchange();

assertThat(result).hasStatus(HttpStatus.OK);
assertThat(result.body().asString()).contains("\"id\":42");
```